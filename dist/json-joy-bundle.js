var Tr=Object.defineProperty;var Br=(o,t,e)=>t in o?Tr(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var l=(o,t,e)=>(Br(o,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(r){if(r.ep)return;r.ep=!0;const i=e(r);fetch(r.href,i)}})();class O{constructor(t,e){l(this,"sid");l(this,"time");this.sid=t,this.time=e}}class be{constructor(t,e,s){l(this,"sid");l(this,"time");l(this,"span");this.sid=t,this.time=e,this.span=s}}const A=(o,t)=>new O(o,t),it=(o,t,e)=>new be(o,t,e),E=(o,t)=>A(o.sid,o.time+t),X=(o,t)=>{const e=o.time,s=t.time;if(e>s)return 1;if(e<s)return-1;const r=o.sid,i=t.sid;return r>i?1:r<i?-1:0},nt=(o,t,e)=>{if(o.sid!==e.sid)return!1;const s=o.time,r=e.time;return!(s>r||s+t<r+1)},m=o=>{if(o.sid===1)return"."+o.time;let t=""+o.sid;return t.length>4&&(t=".."+t.slice(t.length-4)),t+"."+o.time},Dr=(o,t,e)=>new be(o.sid,o.time+t,e);class Ts extends O{tick(t){const e=new O(this.sid,this.time);return this.time+=t,e}}class W extends Ts{constructor(){super(...arguments);l(this,"peers",new Map)}observe(e,s){const r=e.time+s-1,i=e.sid;if(i!==this.sid){const n=this.peers.get(e.sid);n?r>n.time&&(n.time=r):this.peers.set(e.sid,A(i,r))}r>=this.time&&(this.time=r+1)}clone(){return this.fork(this.sid)}fork(e){const s=new W(e,this.time);return e!==this.sid&&s.observe(E(this,-1),1),this.peers.forEach(r=>{s.observe(r,1)}),s}toString(e=""){const s=this.peers.size;let r=1,i="";return this.peers.forEach(n=>{i+=`
${e}${r===s?"└─":"├─"} ${n.sid}.${n.time}`,r++}),`clock ${this.sid}.${this.time}${i}`}}class Xt extends Ts{constructor(){super(...arguments);l(this,"peers",new Map)}observe(e,s){if(e.sid!==1)throw new Error("INVALID_SERVER_SESSION");if(this.time<e.time)throw new Error("TIME_TRAVEL");const r=e.time+s;r>this.time&&(this.time=r)}clone(){return this.fork()}fork(){return new Xt(1,this.time)}toString(){return`clock ${this.sid}.${this.time}`}}class L{constructor(t,e){l(this,"id");l(this,"val");l(this,"api");this.id=t,this.val=e}children(){}child(){}container(){}view(){return this.val}name(){return"con"}toString(t){const e=this.val,s=e instanceof Uint8Array?`Uint8Array { ${(""+e).replaceAll(",",", ")} }`:`{ ${e instanceof O?m(e):JSON.stringify(e)} }`;return`${this.name()} ${m(this.id)} ${s}`}}const C=(o="",t)=>{t=t.filter(Boolean);let e="";for(let s=0;s<t.length;s++){const r=s>=t.length-1,i=t[s];if(!i)continue;const n=i(o+`${r?" ":"│"}  `);e+=`
${o}${n?r?"└─":"├─":"│ "} ${n}`}return e};class It{constructor(t,e){l(this,"id");l(this,"val");this.id=t,this.val=e}span(){return 1}name(){return"new_con"}toString(t=""){const e=this.val,s=e instanceof O?`{ ${m(e)} }`:e instanceof Uint8Array?e.length<13?`Uint8Array { ${(""+e).replaceAll(",",", ")} }`:`Uint8Array(${e.length})`:`{ ${JSON.stringify(e)} }`;return`${this.name()} ${m(this.id)} ${s}`}}class Nt{constructor(t){l(this,"id");this.id=t}span(){return 1}name(){return"new_val"}toString(){return`${this.name()} ${m(this.id)}`}}class At{constructor(t){l(this,"id");this.id=t}span(){return 1}name(){return"new_obj"}toString(){return`${this.name()} ${m(this.id)}`}}class $t{constructor(t){l(this,"id");this.id=t}span(){return 1}name(){return"new_vec"}toString(){return`${this.name()} ${m(this.id)}`}}class Et{constructor(t){l(this,"id");this.id=t}span(){return 1}name(){return"new_str"}toString(){return`${this.name()} ${m(this.id)}`}}class Tt{constructor(t){l(this,"id");this.id=t}span(){return 1}name(){return"new_bin"}toString(t=""){return`${this.name()} ${m(this.id)}`}}class Bt{constructor(t){l(this,"id");this.id=t}span(){return 1}name(){return"new_arr"}toString(){return`${this.name()} ${m(this.id)}`}}class et{constructor(t,e,s){l(this,"id");l(this,"obj");l(this,"val");this.id=t,this.obj=e,this.val=s}span(){return 1}name(){return"ins_val"}toString(t=""){return`${this.name()} ${m(this.id)}!${this.span()}, obj = ${m(this.obj)}, val = ${m(this.val)}`}}class Dt{constructor(t,e,s){l(this,"id");l(this,"obj");l(this,"data");this.id=t,this.obj=e,this.data=s}span(){return 1}name(){return"ins_obj"}toString(t=""){let e=`${this.name()} ${m(this.id)}!${this.span()}, obj = ${m(this.obj)}`;for(let s=0;s<this.data.length;s++){const r=s===this.data.length-1;e+=`
${t}  ${r?"└─":"├─"} ${JSON.stringify(this.data[s][0])}: ${m(this.data[s][1])}`}return e}}class we{constructor(t,e,s){l(this,"id");l(this,"obj");l(this,"data");this.id=t,this.obj=e,this.data=s}span(){return 1}name(){return"ins_vec"}toString(t=""){let e=`${this.name()} ${m(this.id)}!${this.span()}, obj = ${m(this.obj)}`;for(let s=0;s<this.data.length;s++){const r=s===this.data.length-1;e+=`
${t}  ${r?"└─":"├─"} ${JSON.stringify(this.data[s][0])}: ${m(this.data[s][1])}`}return e}}class Ut{constructor(t,e,s,r){l(this,"id");l(this,"obj");l(this,"ref");l(this,"data");this.id=t,this.obj=e,this.ref=s,this.data=r}span(){return this.data.length}name(){return"ins_str"}toString(){return`${this.name()} ${m(this.id)}!${this.span()}, obj = ${m(this.obj)} { ${m(this.ref)} ← ${JSON.stringify(this.data)} }`}}class Pt{constructor(t,e,s,r){l(this,"id");l(this,"obj");l(this,"ref");l(this,"data");this.id=t,this.obj=e,this.ref=s,this.data=r}span(){return this.data.length}name(){return"ins_bin"}toString(t=""){const e=m(this.ref);return`${this.name()} ${m(this.id)}!${this.span()}, obj = ${m(this.obj)} { ${e} ← ${this.data} }`}}class Rt{constructor(t,e,s,r){l(this,"id");l(this,"obj");l(this,"ref");l(this,"data");this.id=t,this.obj=e,this.ref=s,this.data=r}span(){return this.data.length}name(){return"ins_arr"}toString(){return`${this.name()} ${m(this.id)}!${this.span()}, obj = ${m(this.obj)} { ${m(this.ref)} ← ${this.data.map(m).join(", ")} }`}}class Vt{constructor(t,e,s){l(this,"id");l(this,"obj");l(this,"what");this.id=t,this.obj=e,this.what=s}span(){return 1}name(){return"del"}toString(){const t=this.what.map(e=>m(e)+"!"+e.span).join(", ");return`${this.name()} ${m(this.id)}, obj = ${m(this.obj)} { ${t} }`}}class Lt{constructor(t,e){l(this,"id");l(this,"len");this.id=t,this.len=e}span(){return this.len}name(){return"nop"}toString(){return`${this.name()} ${m(this.id)}!${this.len}`}}class Ur{constructor(t,e){l(this,"sessionIndex");l(this,"timeDiff");this.sessionIndex=t,this.timeDiff=e}}class Ie{constructor(t,e){l(this,"index");l(this,"clock");this.index=t,this.clock=e}}class Pr{constructor(){l(this,"table",new Map);l(this,"index",1);l(this,"clock",null)}reset(t){this.index=1,this.clock=t;const e=new Ie(this.index++,E(t,-1));this.table.clear(),this.table.set(t.sid,e)}append(t){const e=t.time,s=t.sid;let r=this.table.get(s);if(!r){let c=this.clock.peers.get(s);c||(c=new O(s,this.clock.time-1)),r=new Ie(this.index++,c),this.table.set(s,r)}const n=r.clock.time-e;if(n<0)throw new Error("TIME_TRAVEL");return new Ur(r.index,n)}toJson(){const t=[];return this.table.forEach(e=>{const s=e.clock;t.push(s.sid,s.time)}),t}}let Rr=class{constructor(t,e,s,r){l(this,"uint8");l(this,"view");l(this,"start");l(this,"end");this.uint8=t,this.view=e,this.start=s,this.end=r}subarray(){return this.uint8.subarray(this.start,this.end)}};const Vr=new Uint8Array([]),Lr=new DataView(Vr.buffer),Bs=typeof Buffer=="function",Ne=Bs?Buffer.prototype.utf8Write:null,Ae=Bs?Buffer.from:null,$e=typeof TextEncoder<"u"?new TextEncoder:null;let Ds=class{constructor(t=64*1024){l(this,"allocSize");l(this,"uint8");l(this,"view",Lr);l(this,"x0",0);l(this,"x",0);l(this,"size");this.allocSize=t,this.uint8=new Uint8Array(t),this.size=t,this.view=new DataView(this.uint8.buffer)}grow(t){const e=this.x0,s=this.x,r=this.uint8,i=new Uint8Array(t),n=new DataView(i.buffer),c=r.subarray(e,s);i.set(c,0),this.x=s-e,this.x0=0,this.uint8=i,this.size=t,this.view=n}ensureCapacity(t){const e=this.size,s=e-this.x;if(s<t){const r=e-this.x0,i=t-s,n=r+i;this.grow(n<=this.allocSize?this.allocSize:n*2)}}move(t){this.ensureCapacity(t),this.x+=t}reset(){this.x0=this.x}newBuffer(t){const e=this.uint8=new Uint8Array(t);this.size=t,this.view=new DataView(e.buffer),this.x=this.x0=0}flush(){const t=this.uint8.subarray(this.x0,this.x);return this.x0=this.x,t}flushSlice(){const t=new Rr(this.uint8,this.view,this.x0,this.x);return this.x0=this.x,t}u8(t){this.ensureCapacity(1),this.uint8[this.x++]=t}u16(t){this.ensureCapacity(2),this.view.setUint16(this.x,t),this.x+=2}u32(t){this.ensureCapacity(4),this.view.setUint32(this.x,t),this.x+=4}i32(t){this.ensureCapacity(4),this.view.setInt32(this.x,t),this.x+=4}u64(t){this.ensureCapacity(8),this.view.setBigUint64(this.x,BigInt(t)),this.x+=8}f64(t){this.ensureCapacity(8),this.view.setFloat64(this.x,t),this.x+=8}u8u16(t,e){this.ensureCapacity(3);let s=this.x;this.uint8[s++]=t,this.uint8[s++]=e>>>8,this.uint8[s++]=e&255,this.x=s}u8u32(t,e){this.ensureCapacity(5);let s=this.x;this.uint8[s++]=t,this.view.setUint32(s,e),this.x=s+4}u8u64(t,e){this.ensureCapacity(9);let s=this.x;this.uint8[s++]=t,this.view.setBigUint64(s,BigInt(e)),this.x=s+8}u8f32(t,e){this.ensureCapacity(5);let s=this.x;this.uint8[s++]=t,this.view.setFloat32(s,e),this.x=s+4}u8f64(t,e){this.ensureCapacity(9);let s=this.x;this.uint8[s++]=t,this.view.setFloat64(s,e),this.x=s+8}buf(t,e){this.ensureCapacity(e);const s=this.x;this.uint8.set(t,s),this.x=s+e}utf8(t){const e=t.length*4;if(e<168)return this.utf8Native(t);if(Ne){const s=Ne.call(this.uint8,t,this.x,e);return this.x+=s,s}else if(Ae){const s=this.uint8,r=s.byteOffset+this.x,n=Ae(s.buffer).subarray(r,r+e).write(t,0,e,"utf8");return this.x+=n,n}else if(e>1024&&$e){const s=$e.encodeInto(t,this.uint8.subarray(this.x,this.x+e)).written;return this.x+=s,s}return this.utf8Native(t)}utf8Native(t){const e=t.length,s=this.uint8;let r=this.x,i=0;for(;i<e;){let c=t.charCodeAt(i++);if(c&4294967168)if(!(c&4294965248))s[r++]=c>>6&31|192;else{if(c>=55296&&c<=56319&&i<e){const a=t.charCodeAt(i);(a&64512)===56320&&(i++,c=((c&1023)<<10)+(a&1023)+65536)}c&4294901760?(s[r++]=c>>18&7|240,s[r++]=c>>12&63|128,s[r++]=c>>6&63|128):(s[r++]=c>>12&15|224,s[r++]=c>>6&63|128)}else{s[r++]=c;continue}s[r++]=c&63|128}const n=r-this.x;return this.x=r,n}ascii(t){const e=t.length;this.ensureCapacity(e);const s=this.uint8;let r=this.x,i=0;for(;i<e;)s[r++]=t.charCodeAt(i++);this.x=r}},xe=class extends Ds{id(t,e){t<=7&&e<=15?this.u8(t<<4|e):(this.b1vu56(1,t),this.vu57(e))}vu57(t){if(t<=127)this.u8(t);else if(t<=16383){this.ensureCapacity(2);const e=this.uint8;e[this.x++]=128|t&127,e[this.x++]=t>>>7}else if(t<=2097151){this.ensureCapacity(3);const e=this.uint8;e[this.x++]=128|t&127,e[this.x++]=128|t>>>7&127,e[this.x++]=t>>>14}else if(t<=268435455){this.ensureCapacity(4);const e=this.uint8;e[this.x++]=128|t&127,e[this.x++]=128|t>>>7&127,e[this.x++]=128|t>>>14&127,e[this.x++]=t>>>21}else{let e=t|0;e<0&&(e+=4294967296);const s=(t-e)/4294967296;if(t<=34359738367){this.ensureCapacity(5);const r=this.uint8;r[this.x++]=128|t&127,r[this.x++]=128|t>>>7&127,r[this.x++]=128|t>>>14&127,r[this.x++]=128|t>>>21&127,r[this.x++]=s<<4|t>>>28}else if(t<=4398046511103){this.ensureCapacity(6);const r=this.uint8;r[this.x++]=128|t&127,r[this.x++]=128|t>>>7&127,r[this.x++]=128|t>>>14&127,r[this.x++]=128|t>>>21&127,r[this.x++]=128|(s&7)<<4|t>>>28,r[this.x++]=s>>>3}else if(t<=562949953421311){this.ensureCapacity(7);const r=this.uint8;r[this.x++]=128|t&127,r[this.x++]=128|t>>>7&127,r[this.x++]=128|t>>>14&127,r[this.x++]=128|t>>>21&127,r[this.x++]=128|(s&7)<<4|t>>>28,r[this.x++]=128|(s&1016)>>>3,r[this.x++]=s>>>10}else{this.ensureCapacity(8);const r=this.uint8;r[this.x++]=128|t&127,r[this.x++]=128|t>>>7&127,r[this.x++]=128|t>>>14&127,r[this.x++]=128|t>>>21&127,r[this.x++]=128|(s&7)<<4|t>>>28,r[this.x++]=128|(s&1016)>>>3,r[this.x++]=128|(s&130048)>>>10,r[this.x++]=s>>>17}}}b1vu56(t,e){if(e<=63)this.u8(t<<7|e);else{const s=t<<7|64;if(e<=8191){this.ensureCapacity(2);const r=this.uint8;r[this.x++]=s|e&63,r[this.x++]=e>>>6}else if(e<=1048575){this.ensureCapacity(3);const r=this.uint8;r[this.x++]=s|e&63,r[this.x++]=128|e>>>6&127,r[this.x++]=e>>>13}else if(e<=134217727){this.ensureCapacity(4);const r=this.uint8;r[this.x++]=s|e&63,r[this.x++]=128|e>>>6&127,r[this.x++]=128|e>>>13&127,r[this.x++]=e>>>20}else{let r=e|0;r<0&&(r+=4294967296);const i=(e-r)/4294967296;if(e<=17179869183){this.ensureCapacity(5);const n=this.uint8;n[this.x++]=s|e&63,n[this.x++]=128|e>>>6&127,n[this.x++]=128|e>>>13&127,n[this.x++]=128|e>>>20&127,n[this.x++]=i<<5|e>>>27}else if(e<=2199023255551){this.ensureCapacity(6);const n=this.uint8;n[this.x++]=s|e&63,n[this.x++]=128|e>>>6&127,n[this.x++]=128|e>>>13&127,n[this.x++]=128|e>>>20&127,n[this.x++]=128|(i&3)<<5|e>>>27,n[this.x++]=i>>>2}else if(e<=0xffffffffffff){this.ensureCapacity(7);const n=this.uint8;n[this.x++]=s|e&63,n[this.x++]=128|e>>>6&127,n[this.x++]=128|e>>>13&127,n[this.x++]=128|e>>>20&127,n[this.x++]=128|(i&3)<<5|e>>>27,n[this.x++]=128|(i&508)>>>2,n[this.x++]=i>>>9}else{this.ensureCapacity(8);const n=this.uint8;n[this.x++]=s|e&63,n[this.x++]=128|e>>>6&127,n[this.x++]=128|e>>>13&127,n[this.x++]=128|e>>>20&127,n[this.x++]=128|(i&3)<<5|e>>>27,n[this.x++]=128|(i&508)>>>2,n[this.x++]=128|(i&65024)>>>9,n[this.x++]=i>>>16}}}}};const Ee=new DataView(new ArrayBuffer(4)),Mr=o=>(Ee.setFloat32(0,o),o===Ee.getFloat32(0));let Us=class{constructor(t,e){l(this,"tag");l(this,"val");this.tag=t,this.val=e}};const Fr=Number.isSafeInteger;let qr=class{constructor(t=new Ds){l(this,"writer");this.writer=t}encode(t){return this.writeAny(t),this.writer.flush()}encodeToSlice(t){return this.writeAny(t),this.writer.flushSlice()}writeAny(t){switch(typeof t){case"number":return this.writeNumber(t);case"string":return this.writeStr(t);case"boolean":return this.writer.u8(244+ +t);case"object":{if(!t)return this.writer.u8(246);switch(t.constructor){case Array:return this.writeArr(t);default:return this.writeObj(t)}}}}writeCbor(){this.writer.u8u16(217,55799)}writeEnd(){this.writer.u8(255)}writeNull(){this.writer.u8(246)}writeBoolean(t){t?this.writer.u8(245):this.writer.u8(244)}writeNumber(t){Fr(t)?this.writeInteger(t):typeof t=="bigint"?this.writeBigInt(t):this.writeFloat(t)}writeBigInt(t){t>=0?this.writeBigUint(t):this.writeBigSint(t)}writeBigUint(t){if(t<=Number.MAX_SAFE_INTEGER)return this.writeUInteger(Number(t));this.writer.u8u64(27,t)}writeBigSint(t){if(t>=Number.MIN_SAFE_INTEGER)return this.encodeNint(Number(t));const e=-BigInt(1)-t;this.writer.u8u64(59,e)}writeInteger(t){t>=0?this.writeUInteger(t):this.encodeNint(t)}writeUInteger(t){const e=this.writer;e.ensureCapacity(9);const s=e.uint8;let r=e.x;t<=23?s[r++]=0+t:t<=255?(s[r++]=24,s[r++]=t):t<=65535?(s[r++]=25,e.view.setUint16(r,t),r+=2):t<=4294967295?(s[r++]=26,e.view.setUint32(r,t),r+=4):(s[r++]=27,e.view.setBigUint64(r,BigInt(t)),r+=8),e.x=r}encodeNumber(t){this.writeNumber(t)}encodeInteger(t){this.writeInteger(t)}encodeUint(t){this.writeUInteger(t)}encodeNint(t){const e=-1-t,s=this.writer;s.ensureCapacity(9);const r=s.uint8;let i=s.x;e<24?r[i++]=32+e:e<=255?(r[i++]=56,r[i++]=e):e<=65535?(r[i++]=57,s.view.setUint16(i,e),i+=2):e<=4294967295?(r[i++]=58,s.view.setUint32(i,e),i+=4):(r[i++]=59,s.view.setBigUint64(i,BigInt(e)),i+=8),s.x=i}writeFloat(t){this.writer.u8f64(251,t)}writeBin(t){const e=t.length;this.writeBinHdr(e),this.writer.buf(t,e)}writeBinHdr(t){const e=this.writer;t<=23?e.u8(64+t):t<=255?e.u16(22528+t):t<=65535?e.u8u16(89,t):t<=4294967295?e.u8u32(90,t):e.u8u64(91,t)}writeStr(t){const e=this.writer,r=t.length*4;e.ensureCapacity(5+r);const i=e.uint8;let n=e.x;r<=23?e.x++:r<=255?(i[e.x++]=120,n=e.x,e.x++):r<=65535?(i[e.x++]=121,n=e.x,e.x+=2):(i[e.x++]=122,n=e.x,e.x+=4);const c=e.utf8(t);r<=23?i[n]=96+c:r<=255?i[n]=c:r<=65535?e.view.setUint16(n,c):e.view.setUint32(n,c)}writeStrHdr(t){const e=this.writer;t<=23?e.u8(96+t):t<=255?e.u16(30720+t):t<=65535?e.u8u16(121,t):e.u8u32(122,t)}writeAsciiStr(t){this.writeStrHdr(t.length),this.writer.ascii(t)}writeArr(t){const e=t.length;this.writeArrHdr(e);for(let s=0;s<e;s++)this.writeAny(t[s])}writeArrHdr(t){const e=this.writer;t<=23?e.u8(128+t):t<=255?e.u16(38912+t):t<=65535?e.u8u16(153,t):t<=4294967295?e.u8u32(154,t):e.u8u64(155,t)}writeObj(t){const e=Object.keys(t),s=e.length;this.writeObjHdr(s);for(let r=0;r<s;r++){const i=e[r];this.writeStr(i),this.writeAny(t[i])}}writeObjHdr(t){const e=this.writer;t<=23?e.u8(160+t):t<=255?e.u16(47104+t):t<=65535?e.u8u16(185,t):t<=4294967295?e.u8u32(186,t):e.u8u64(187,t)}writeMapHdr(t){this.writeObjHdr(t)}writeStartMap(){this.writer.u8(191)}writeTag(t,e){this.writeTagHdr(t),this.writeAny(e)}writeTagHdr(t){const e=this.writer;t<=23?e.u8(192+t):t<=255?e.u16(55296+t):t<=65535?e.u8u16(217,t):t<=4294967295?e.u8u32(218,t):e.u8u64(219,t)}writeTkn(t){const e=this.writer;t<=23?e.u8(224+t):t<=255&&e.u16(63488+t)}writeStartStr(){this.writer.u8(127)}writeStrChunk(t){throw new Error("Not implemented")}writeEndStr(){throw new Error("Not implemented")}writeStartBin(){this.writer.u8(95)}writeBinChunk(t){throw new Error("Not implemented")}writeEndBin(){throw new Error("Not implemented")}writeStartArr(){this.writer.u8(159)}writeArrChunk(t){throw new Error("Not implemented")}writeEndArr(){this.writer.u8(255)}writeStartObj(){this.writer.u8(191)}writeObjChunk(t,e){throw new Error("Not implemented")}writeEndObj(){this.writer.u8(255)}},Ps=class extends qr{writeUnknown(t){this.writeNull()}writeAny(t){switch(typeof t){case"number":return this.writeNumber(t);case"string":return this.writeStr(t);case"boolean":return this.writer.u8(244+ +t);case"object":{if(!t)return this.writer.u8(246);switch(t.constructor){case Object:return this.writeObj(t);case Array:return this.writeArr(t);case Uint8Array:return this.writeBin(t);case Map:return this.writeMap(t);case Us:return this.writeTag(t.tag,t.val);default:return this.writeUnknown(t)}}case"undefined":return this.writeUndef();case"bigint":return this.writeBigInt(t);default:return this.writeUnknown(t)}}writeFloat(t){Mr(t)?this.writer.u8f32(250,t):this.writer.u8f64(251,t)}writeMap(t){this.writeMapHdr(t.size),t.forEach((e,s)=>{this.writeAny(s),this.writeAny(e)})}writeUndef(){this.writer.u8(247)}},Jr=class extends Ps{constructor(e){super(e||new xe);l(this,"clockEncoder",new Pr);l(this,"time",0);l(this,"doc");l(this,"cTableEntry",e=>{const s=e.clock,r=this.writer;r.vu57(s.sid),r.vu57(s.time)});l(this,"tsLogical",e=>{const s=this.clockEncoder.append(e);this.writer.id(s.sessionIndex,s.timeDiff)});l(this,"tsServer",e=>{this.writer.vu57(e.time)});l(this,"ts",this.tsLogical);l(this,"cKey",(e,s)=>{this.writeStr(s),this.cNode(this.doc.index.get(e))})}encode(e){this.doc=e;const s=this.writer;return s.reset(),e.clock.sid===1?this.encodeServer(e):this.encodeLogical(e),s.flush()}encodeLogical(e){const s=this.writer;this.ts=this.tsLogical,this.clockEncoder.reset(e.clock),s.ensureCapacity(4);const r=s.x0,i=s.x;s.x+=4,this.cRoot(e.root),this.encodeClockTable(r,i)}encodeServer(e){this.ts=this.tsServer;const s=this.writer;s.u8(128),s.vu57(this.time=e.clock.time),this.cRoot(e.root)}encodeClockTable(e,s){const r=this.writer,i=r.x0-e;r.view.setUint32(r.x0+(s-e),r.x-s-i-4);const c=this.clockEncoder.table,a=c.size;r.vu57(a),c.forEach(this.cTableEntry)}cRoot(e){e.val.sid===0?this.writer.u8(0):this.cNode(e.node())}writeTL(e,s){const r=this.writer;s<31?r.u8(e|s):(r.u8(e|31),r.vu57(s))}cNode(e){e instanceof L?this.cCon(e):e instanceof P?this.cVal(e):e instanceof U?this.cStr(e):e instanceof V?this.cObj(e):e instanceof R?this.cVec(e):e instanceof $?this.cArr(e):e instanceof D&&this.cBin(e)}cCon(e){const s=e.val;this.ts(e.id),s instanceof O?(this.writer.u8(1),this.ts(s)):(this.writer.u8(0),this.writeAny(s))}cVal(e){this.ts(e.id),this.writer.u8(32),this.cNode(e.node())}cObj(e){this.ts(e.id);const s=e.keys;this.writeTL(64,s.size),s.forEach(this.cKey)}cVec(e){const s=e.elements,r=s.length;this.ts(e.id),this.writeTL(96,r);const i=this.doc.index;for(let n=0;n<r;n++){const c=s[n];c?this.cNode(i.get(c)):this.writer.u8(0)}}cStr(e){const s=this.ts;s(e.id),this.writeTL(128,e.count);for(let r=e.first();r;r=e.next(r))s(r.id),r.del?this.writeUInteger(r.span):this.writeStr(r.data)}cBin(e){const s=this.ts,r=this.writer;s(e.id),this.writeTL(160,e.count);for(let i=e.first();i;i=e.next(i)){s(i.id);const n=i.span,c=i.del;r.b1vu56(~~c,n),!c&&r.buf(i.data,n)}}cArr(e){const s=this.ts,r=this.writer;s(e.id),this.writeTL(192,e.count);const i=this.doc.index;for(let n=e.first();n;n=e.next(n)){s(n.id);const c=n.span,a=n.del;if(r.b1vu56(~~a,c),a)continue;const h=n.data;for(let d=0;d<c;d++)this.cNode(i.get(h[d]))}}};class ye{constructor(t,e){l(this,"table",[]);l(this,"clock");this.clock=new W(t,e+1),this.table.push(A(t,e))}static fromArr(t){const e=new ye(t[0],t[1]),s=t.length;for(let r=2;r<s;r+=2)e.pushTuple(t[r],t[r+1]);return e}pushTuple(t,e){const s=A(t,e);this.clock.observe(s,1),this.table.push(s)}decodeId(t,e){if(!t)return A(0,e);const s=this.table[t-1];if(!s)throw new Error("INVALID_CLOCK_TABLE");return A(s.sid,s.time-e)}}const S=String.fromCharCode,Hr=(o,t,e)=>{const s=[];for(let r=0;r<e;r++){const i=o[t++];if(i&128)return;s.push(i)}return S.apply(String,s)},Wr=(o,t,e)=>{if(e<4)if(e<2){if(e===0)return"";{const s=o[t++];if((s&128)>1){t-=1;return}return S(s)}}else{const s=o[t++],r=o[t++];if((s&128)>0||(r&128)>0){t-=2;return}if(e<3)return S(s,r);const i=o[t++];if((i&128)>0){t-=3;return}return S(s,r,i)}else{const s=o[t++],r=o[t++],i=o[t++],n=o[t++];if((s&128)>0||(r&128)>0||(i&128)>0||(n&128)>0){t-=4;return}if(e<6){if(e===4)return S(s,r,i,n);{const c=o[t++];if((c&128)>0){t-=5;return}return S(s,r,i,n,c)}}else if(e<8){const c=o[t++],a=o[t++];if((c&128)>0||(a&128)>0){t-=6;return}if(e<7)return S(s,r,i,n,c,a);const h=o[t++];if((h&128)>0){t-=7;return}return S(s,r,i,n,c,a,h)}else{const c=o[t++],a=o[t++],h=o[t++],d=o[t++];if((c&128)>0||(a&128)>0||(h&128)>0||(d&128)>0){t-=8;return}if(e<10){if(e===8)return S(s,r,i,n,c,a,h,d);{const u=o[t++];if((u&128)>0){t-=9;return}return S(s,r,i,n,c,a,h,d,u)}}else if(e<12){const u=o[t++],f=o[t++];if((u&128)>0||(f&128)>0){t-=10;return}if(e<11)return S(s,r,i,n,c,a,h,d,u,f);const p=o[t++];if((p&128)>0){t-=11;return}return S(s,r,i,n,c,a,h,d,u,f,p)}else{const u=o[t++],f=o[t++],p=o[t++],x=o[t++];if((u&128)>0||(f&128)>0||(p&128)>0||(x&128)>0){t-=12;return}if(e<14){if(e===12)return S(s,r,i,n,c,a,h,d,u,f,p,x);{const b=o[t++];if((b&128)>0){t-=13;return}return S(s,r,i,n,c,a,h,d,u,f,p,x,b)}}else{const b=o[t++],w=o[t++];if((b&128)>0||(w&128)>0){t-=14;return}if(e<15)return S(s,r,i,n,c,a,h,d,u,f,p,x,b,w);const y=o[t++];if((y&128)>0){t-=15;return}return S(s,r,i,n,c,a,h,d,u,f,p,x,b,w,y)}}}}},Kr=String.fromCharCode,ge=(o,t,e)=>{let s=t;const r=s+e,i=[];for(;s<r;){let n=o[s++];if(n&128){const c=o[s++]&63;if((n&224)===192)n=(n&31)<<6|c;else{const a=o[s++]&63;if((n&240)===224)n=(n&31)<<12|c<<6|a;else if((n&248)===240){const h=o[s++]&63;let d=(n&7)<<18|c<<12|a<<6|h;if(d>65535){d-=65536;const u=d>>>10&1023|55296;n=56320|d&1023,i.push(u)}else n=d}}}i.push(n)}return Kr.apply(String,i)},Rs=typeof Buffer<"u",Te=Rs?Buffer.prototype.utf8Slice:null,Be=Rs?Buffer.from:null,zr=(o,t,e)=>Wr(o,t,e)??ge(o,t,e),Yr=(o,t,e)=>Hr(o,t,e)??ge(o,t,e),Gr=Te?(o,t,e)=>Te.call(o,t,t+e):Be?(o,t,e)=>Be(o).subarray(t,t+e).toString("utf8"):ge,Xr=(o,t,e)=>e<16?zr(o,t,e):e<32?Yr(o,t,e):Gr(o,t,e);let Vs=class{constructor(){l(this,"uint8",new Uint8Array([]));l(this,"view",new DataView(this.uint8.buffer));l(this,"x",0)}reset(t){this.x=0,this.uint8=t,this.view=new DataView(t.buffer,t.byteOffset,t.length)}peak(){return this.view.getUint8(this.x)}skip(t){this.x+=t}buf(t){const e=this.x+t,s=this.uint8.subarray(this.x,e);return this.x=e,s}u8(){return this.uint8[this.x++]}i8(){return this.view.getInt8(this.x++)}u16(){let t=this.x;const e=(this.uint8[t++]<<8)+this.uint8[t++];return this.x=t,e}i16(){const t=this.view.getInt16(this.x);return this.x+=2,t}u32(){const t=this.view.getUint32(this.x);return this.x+=4,t}i32(){const t=this.view.getInt32(this.x);return this.x+=4,t}u64(){const t=this.view.getBigUint64(this.x);return this.x+=8,t}i64(){const t=this.view.getBigInt64(this.x);return this.x+=8,t}f32(){const t=this.x;return this.x+=4,this.view.getFloat32(t)}f64(){const t=this.x;return this.x+=8,this.view.getFloat64(t)}utf8(t){const e=this.x;return this.x+=t,Xr(this.uint8,e,t)}ascii(t){const e=this.uint8;let s="";const r=this.x+t;for(let i=this.x;i<r;i++)s+=String.fromCharCode(e[i]);return this.x=r,s}},Ls=class extends Vs{id(){const t=this.u8();return t<=127?[t>>>4,t&15]:(this.x--,[this.b1vu56()[1],this.vu57()])}idSkip(){this.u8()<=127||(this.x--,this.b1vu56(),this.vu57Skip())}vu57(){const t=this.u8();if(t<=127)return t;const e=this.u8();if(e<=127)return e<<7|t&127;const s=this.u8();if(s<=127)return s<<14|(e&127)<<7|t&127;const r=this.u8();if(r<=127)return r<<21|(s&127)<<14|(e&127)<<7|t&127;const i=this.u8();if(i<=127)return i*268435456+((r&127)<<21|(s&127)<<14|(e&127)<<7|t&127);const n=this.u8();if(n<=127)return n*34359738368+((i&127)*268435456+((r&127)<<21|(s&127)<<14|(e&127)<<7|t&127));const c=this.u8();return c<=127?c*4398046511104+((n&127)*34359738368+((i&127)*268435456+((r&127)<<21|(s&127)<<14|(e&127)<<7|t&127))):this.u8()*562949953421312+((c&127)*4398046511104+((n&127)*34359738368+((i&127)*268435456+((r&127)<<21|(s&127)<<14|(e&127)<<7|t&127))))}vu57Skip(){this.u8()<=127||this.u8()<=127||this.u8()<=127||this.u8()<=127||this.u8()<=127||this.u8()<=127||this.u8()<=127||this.x++}b1vu56(){const t=this.u8(),e=t&128?1:0,s=127&t;if(s<=63)return[e,s];const r=this.u8();if(r<=127)return[e,r<<6|s&63];const i=this.u8();if(i<=127)return[e,i<<13|(r&127)<<6|s&63];const n=this.u8();if(n<=127)return[e,n<<20|(i&127)<<13|(r&127)<<6|s&63];const c=this.u8();if(c<=127)return[e,c*134217728+((n&127)<<20|(i&127)<<13|(r&127)<<6|s&63)];const a=this.u8();if(a<=127)return[e,a*17179869184+((c&127)*134217728+((n&127)<<20|(i&127)<<13|(r&127)<<6|s&63))];const h=this.u8();if(h<=127)return[e,h*2199023255552+((a&127)*17179869184+((c&127)*134217728+((n&127)<<20|(i&127)<<13|(r&127)<<6|s&63)))];const d=this.u8();return[e,d*281474976710656+((h&127)*2199023255552+((a&127)*17179869184+((c&127)*134217728+((n&127)<<20|(i&127)<<13|(r&127)<<6|s&63))))]}};const Qr=Math.pow,Zr=o=>{const t=(o&31744)>>10,e=o&1023;return(o>>15?-1:1)*(t?t===31?e?NaN:1/0:Qr(2,t-15)*(1+e/1024):6103515625e-14*(e/1024))};let ue=class{constructor(t){l(this,"val");this.val=t}};const tt=String.fromCharCode,ti=(o,t,e)=>{let s=t;const r=s+e;let i="";for(;s<r;){const n=o[s++];if(!(n&128)){i+=tt(n);continue}const c=o[s++]&63;if((n&224)===192){i+=tt((n&31)<<6|c);continue}const a=o[s++]&63;if((n&240)===224){i+=tt((n&31)<<12|c<<6|a);continue}if((n&248)===240){const h=o[s++]&63;let d=(n&7)<<18|c<<12|a<<6|h;if(d>65535){d-=65536;const u=d>>>10&1023|55296;d=56320|d&1023,i+=tt(u,d)}else i+=tt(d)}else i+=tt(n)}return i};function ei(o){if(o.__esModule)return o;var t=o.default;if(typeof t=="function"){var e=function s(){return this instanceof s?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};e.prototype=t.prototype}else e={};return Object.defineProperty(e,"__esModule",{value:!0}),Object.keys(o).forEach(function(s){var r=Object.getOwnPropertyDescriptor(o,s);Object.defineProperty(e,s,r.get?r:{enumerable:!0,get:function(){return o[s]}})}),e}var se={},De;function Ms(){if(De)return se;De=1;var o=1+Math.round(Math.random()*((-1>>>0)-1));function t(e,s){return o^=o<<13,o^=o>>>17,o^=o<<5,(o>>>0)%(s-e+1)+e}return se.randomU32=t,se}var si=Ms();class ri{constructor(t,e){l(this,"bytes");l(this,"value");this.bytes=t,this.value=e}}let ii=class{constructor(){l(this,"caches");this.caches=[];for(let t=0;t<31;t++)this.caches.push([])}get(t,e,s){const r=this.caches[s-1],i=r.length;t:for(let n=0;n<i;n++){const c=r[n],a=c.bytes;for(let h=0;h<s;h++)if(a[h]!==t[e+h])continue t;return c.value}return null}store(t,e){const s=this.caches[t.length-1],r=new ri(t,e);s.length>=16?s[si.randomU32(0,15)]=r:s.push(r)}decode(t,e,s){if(!s)return"";const r=this.get(t,e,s);if(r!==null)return r;const i=ti(t,e,s),n=Uint8Array.prototype.slice.call(t,e,e+s);return this.store(n,i),i}};const ni=new ii;let Fs=class{constructor(t=new Vs,e=ni){l(this,"reader");l(this,"keyDecoder");this.reader=t,this.keyDecoder=e}read(t){return this.reader.reset(t),this.val()}decode(t){return this.reader.reset(t),this.val()}val(){const e=this.reader.u8(),s=e>>5,r=e&31;return s<4?s<2?s===0?this.readUint(r):this.readNint(r):s===2?this.readBin(r):this.readStr(r):s<6?s===4?this.readArr(r):this.readObj(r):s===6?this.readTag(r):this.readTkn(r)}readAnyRaw(t){const e=t>>5,s=t&31;return e<4?e<2?e===0?this.readUint(s):this.readNint(s):e===2?this.readBin(s):this.readStr(s):e<6?e===4?this.readArr(s):this.readObj(s):e===6?this.readTag(s):this.readTkn(s)}readMinorLen(t){if(t<24)return t;switch(t){case 24:return this.reader.u8();case 25:return this.reader.u16();case 26:return this.reader.u32();case 27:return Number(this.reader.u64());case 31:return-1;default:throw 1}}readUint(t){if(t<25)return t===24?this.reader.u8():t;if(t<27)return t===25?this.reader.u16():this.reader.u32();{const e=this.reader.u64();return e>9007199254740991?e:Number(e)}}readNint(t){if(t<25)return t===24?-this.reader.u8()-1:-t-1;if(t<27)return t===25?-this.reader.u16()-1:-this.reader.u32()-1;{const e=this.reader.u64();return e>9007199254740991-1?-e-BigInt(1):-Number(e)-1}}readBin(t){const e=this.reader;if(t<=23)return e.buf(t);switch(t){case 24:return e.buf(e.u8());case 25:return e.buf(e.u16());case 26:return e.buf(e.u32());case 27:return e.buf(Number(e.u64()));case 31:{let s=0;const r=[];for(;this.reader.peak()!==255;){const a=this.readBinChunk();s+=a.length,r.push(a)}this.reader.x++;const i=new Uint8Array(s);let n=0;const c=r.length;for(let a=0;a<c;a++){const h=r[a];i.set(h,n),n+=h.length}return i}default:throw 1}}readBinChunk(){const t=this.reader.u8(),e=t>>5,s=t&31;if(e!==2)throw 2;if(s>27)throw 3;return this.readBin(s)}readAsStr(){const e=this.reader.u8(),s=e>>5,r=e&31;if(s!==3)throw 11;return this.readStr(r)}readStr(t){const e=this.reader;if(t<=23)return e.utf8(t);switch(t){case 24:return e.utf8(e.u8());case 25:return e.utf8(e.u16());case 26:return e.utf8(e.u32());case 27:return e.utf8(Number(e.u64()));case 31:{let s="";for(;e.peak()!==255;)s+=this.readStrChunk();return this.reader.x++,s}default:throw 1}}readStrLen(t){if(t<=23)return t;switch(t){case 24:return this.reader.u8();case 25:return this.reader.u16();case 26:return this.reader.u32();case 27:return Number(this.reader.u64());default:throw 1}}readStrChunk(){const t=this.reader.u8(),e=t>>5,s=t&31;if(e!==3)throw 4;if(s>27)throw 5;return this.readStr(s)}readArr(t){const e=this.readMinorLen(t);return e>=0?this.readArrRaw(e):this.readArrIndef()}readArrRaw(t){const e=[];for(let s=0;s<t;s++)e.push(this.val());return e}readArrIndef(){const t=[];for(;this.reader.peak()!==255;)t.push(this.val());return this.reader.x++,t}readObj(t){if(t<28){let e=t;switch(t){case 24:e=this.reader.u8();break;case 25:e=this.reader.u16();break;case 26:e=this.reader.u32();break;case 27:e=Number(this.reader.u64());break}const s={};for(let r=0;r<e;r++){const i=this.key();if(i==="__proto__")throw 6;const n=this.val();s[i]=n}return s}else{if(t===31)return this.readObjIndef();throw 1}}readObjRaw(t){const e={};for(let s=0;s<t;s++){const r=this.key(),i=this.val();e[r]=i}return e}readObjIndef(){const t={};for(;this.reader.peak()!==255;){const e=this.key();if(this.reader.peak()===255)throw 7;const s=this.val();t[e]=s}return this.reader.x++,t}key(){const t=this.reader.u8(),e=t>>5,s=t&31;if(e!==3)return String(this.readAnyRaw(t));const r=this.readStrLen(s);if(r>31)return this.reader.utf8(r);const i=this.keyDecoder.decode(this.reader.uint8,this.reader.x,r);return this.reader.skip(r),i}readTag(t){if(t<=23)return this.readTagRaw(t);switch(t){case 24:return this.readTagRaw(this.reader.u8());case 25:return this.readTagRaw(this.reader.u16());case 26:return this.readTagRaw(this.reader.u32());case 27:return this.readTagRaw(Number(this.reader.u64()));default:throw 1}}readTagRaw(t){return new Us(t,this.val())}readTkn(t){switch(t){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;case 24:return new ue(this.reader.u8());case 25:return this.f16();case 26:return this.reader.f32();case 27:return this.reader.f64()}if(t<=23)return new ue(t);throw 1}f16(){return Zr(this.reader.u16())}},oi=class extends Fs{constructor(){super(new Ls);l(this,"doc");l(this,"clockDecoder");l(this,"time",-1);l(this,"cStrChunk",()=>{const e=this.ts(),s=this.val();return typeof s=="string"?new G(e,s.length,s):new G(e,~~s,"")});l(this,"cBinChunk",()=>{const e=this.ts(),s=this.reader,[r,i]=s.b1vu56();return r?new Y(e,i,void 0):new Y(e,i,s.buf(i))});l(this,"cArrChunk",()=>{const e=this.ts(),[s,r]=this.reader.b1vu56();if(s)return new z(e,r,void 0);const i=[];for(let n=0;n<r;n++)i.push(this.cNode().id);return new z(e,r,i)})}decode(e,s){delete this.clockDecoder,this.time=-1;const r=this.reader;if(r.reset(e),r.peak()&128){r.x++;const n=this.time=r.vu57();s||(s=K.withServerClock(n))}else if(this.decodeClockTable(),!s){const n=this.clockDecoder.clock;s=K.withLogicalClock(n)}return this.doc=s,s.root=new Gs(this.doc,this.cRoot().id),delete this.clockDecoder,s}decodeClockTable(){const e=this.reader,s=e.u32(),r=e.x;e.x+=s;const i=e.vu57(),n=e.vu57(),c=e.vu57();this.clockDecoder=new ye(n,c);for(let a=1;a<i;a++){const h=e.vu57(),d=e.vu57();this.clockDecoder.pushTuple(h,d)}e.x=r}ts(){if(this.time<0){const[r,i]=this.reader.id();return this.clockDecoder.decodeId(r,i)}else return new O(1,this.reader.vu57())}cRoot(){const e=this.reader;return e.uint8[e.x]?this.cNode():Ys}cNode(){const e=this.reader,s=this.ts(),r=e.u8(),i=r>>5,n=r&31;switch(i){case 0:return this.cCon(s,n);case 1:return this.cVal(s);case 2:return this.cObj(s,n!==31?n:e.vu57());case 3:return this.cVec(s,n!==31?n:e.vu57());case 4:return this.cStr(s,n!==31?n:e.vu57());case 5:return this.cBin(s,n!==31?n:e.vu57());case 6:return this.cArr(s,n!==31?n:e.vu57())}throw new Error("UNKNOWN_NODE")}cCon(e,s){const r=this.doc,i=s?this.ts():this.val(),n=new L(e,i);return r.index.set(e,n),n}cVal(e){const s=this.cNode(),r=this.doc,i=new P(r,e,s.id);return r.index.set(e,i),i}cObj(e,s){const r=new V(this.doc,e);for(let i=0;i<s;i++)this.cObjChunk(r);return this.doc.index.set(e,r),r}cObjChunk(e){const s=this.key();e.keys.set(s,this.cNode().id)}cVec(e,s){const r=this.reader,i=new R(this.doc,e),n=i.elements;for(let c=0;c<s;c++)r.peak()?n.push(this.cNode().id):(r.x++,n.push(void 0));return this.doc.index.set(e,i),i}cStr(e,s){const r=new U(e);return s&&r.ingest(s,this.cStrChunk),this.doc.index.set(e,r),r}cBin(e,s){const r=new D(e);return s&&r.ingest(s,this.cBinChunk),this.doc.index.set(e,r),r}cArr(e,s){const r=new $(this.doc,e);return s&&r.ingest(s,this.cArrChunk),this.doc.index.set(e,r),r}};const ci=new Jr,Ue=new oi;var ve={};Object.defineProperty(ve,"__esModule",{value:!0});var j=ve.FanOut=void 0;class ai{constructor(){this.listeners=new Set}emit(t){this.listeners.forEach(e=>e(t))}listen(t){const e=this.listeners;return e.add(t),()=>e.delete(t)}}j=ve.FanOut=ai;const hi=/~1/g,ui=/~0/g;function di(o){return o.indexOf("~")===-1?o:o.replace(hi,"/").replace(ui,"~")}function fi(o){return o?o.slice(1).split("/").map(di):[]}const li=o=>typeof o=="string"?fi(o):o,pi=(o,t)=>{const e=li(t);let s=o;const r=e.length;if(!r)return s;let i=0;for(;i<r&&s;){const n=e[i++];if(s=s.container(),!s)throw new Error("NOT_CONTAINER");if(s instanceof V){const c=s.get(String(n));if(!c)throw new Error("NOT_FOUND");s=c}else if(s instanceof $){const c=s.getNode(Number(n));if(!c)throw new Error("NOT_FOUND");s=c}else if(s instanceof R){const c=s.get(Number(n));if(!c)throw new Error("NOT_FOUND");s=c}}return s};class bi extends j{constructor(e){super();l(this,"fanouts");l(this,"unsubs",[]);this.fanouts=e}listen(e){this.listeners.size||(this.unsubs=this.fanouts.map(r=>r.listen(i=>this.emit(i))));const s=super.listen(e);return()=>{s(),this.listeners.size||(this.unsubs.forEach(r=>r()),this.unsubs=[])}}}class Pe extends j{constructor(e){super();l(this,"source");l(this,"buffer",[]);l(this,"unsub");this.source=e}listen(e){this.unsub||(this.unsub=this.source.listen(r=>{const i=this.buffer;i.length||queueMicrotask(()=>{this.emit(i),this.buffer=[]}),i.push(r)}));const s=super.listen(e);return()=>{s(),this.listeners.size||this.clear()}}clear(){var e;this.listeners.clear(),this.buffer=[],(e=this.unsub)==null||e.call(this),this.unsub=void 0}}class wi extends j{constructor(e,s){super();l(this,"source");l(this,"mapper");l(this,"unsub");this.source=e,this.mapper=s}listen(e){this.unsub||(this.unsub=this.source.listen(r=>this.emit(this.mapper(r))));const s=super.listen(e);return()=>{s(),this.listeners.size||this.clear()}}clear(){var e;this.listeners.clear(),(e=this.unsub)==null||e.call(this),this.unsub=void 0}}class xi extends j{constructor(e,s=void 0){super();l(this,"source");l(this,"last");l(this,"unsub");this.source=e,this.last=s}listen(e){this.unsub||(this.unsub=this.source.listen(r=>{this.last!==r&&this.emit(this.last=r)}));const s=super.listen(e);return()=>{s(),this.listeners.size||this.clear()}}clear(){var e;this.listeners.clear(),this.last=void 0,(e=this.unsub)==null||e.call(this),this.unsub=void 0}}class yi{constructor(t){l(this,"api");l(this,"onChanges");l(this,"onViewChanges");l(this,"subscribe",t=>this.onViewChanges.listen(()=>t()));l(this,"getSnapshot",()=>this.api.view());this.api=t,this.onChanges=new wi(this.api.api.onChanges,this.getSnapshot),this.onViewChanges=new xi(this.onChanges,this.api.view())}handleDelete(){this.onViewChanges.clear(),this.onChanges.clear()}}class Q{constructor(t,e){l(this,"node");l(this,"api");l(this,"ev");this.node=t,this.api=e}get events(){return this.ev||(this.ev=new yi(this))}find(t){const e=this.node;if(t===void 0){if(typeof e.child=="function"){const s=e.child();if(!s)throw new Error("NO_CHILD");return s}throw new Error("CANNOT_IN")}return typeof t=="string"&&t&&t[0]!=="/"&&(t="/"+t),typeof t=="number"&&(t=[t]),pi(this.node,t)}in(t){const e=this.find(t);return this.api.wrap(e)}asVal(){if(this.node instanceof P)return this.api.wrap(this.node);throw new Error("NOT_VAL")}asStr(){if(this.node instanceof U)return this.api.wrap(this.node);throw new Error("NOT_STR")}asBin(){if(this.node instanceof D)return this.api.wrap(this.node);throw new Error("NOT_BIN")}asArr(){if(this.node instanceof $)return this.api.wrap(this.node);throw new Error("NOT_ARR")}asTup(){if(this.node instanceof R)return this.api.wrap(this.node);throw new Error("NOT_ARR")}asObj(){if(this.node instanceof V)return this.api.wrap(this.node);throw new Error("NOT_OBJ")}asCon(){if(this.node instanceof L)return this.api.wrap(this.node);throw new Error("NOT_CONST")}asExt(t){let e=this.node;for(;e;){if(e instanceof t.Node)return new t.Api(e,this.api);e=e.child?e.child():void 0}throw new Error("NOT_EXT")}val(t){return this.in(t).asVal()}str(t){return this.in(t).asStr()}bin(t){return this.in(t).asBin()}arr(t){return this.in(t).asArr()}tup(t){return this.in(t).asTup()}obj(t){return this.in(t).asObj()}const(t){return this.in(t).asCon()}view(){return this.node.view()}toString(t=""){return this.constructor.name+C(t,[e=>this.node.toString(e)])}}class gi extends Q{proxy(){return{toApi:()=>this,toView:()=>this.node.view()}}}class Re extends Q{get(){return this.in()}set(t){const{api:e,node:s}=this,i=e.builder.constOrJson(t);return e.builder.setVal(s.id,i),e.apply(),this}proxy(){const t=this;return{toApi:()=>this,toView:()=>this.node.view(),get val(){const s=t.node.node();return t.api.wrap(s).proxy()}}}}class vi extends Q{get(t){return this.in(t)}set(t){const{api:e,node:s}=this,{builder:r}=e;return r.insVec(s.id,t.map(([i,n])=>[i,r.constOrJson(n)])),e.apply(),this}push(...t){const e=this.length();this.set(t.map((s,r)=>[e+r,s]))}length(){return this.node.elements.length}proxy(){return new Proxy({},{get:(e,s,r)=>{if(s==="toApi")return()=>this;if(s==="toView")return()=>this.view();const i=Number(s);if(Number.isNaN(i))throw new Error("INVALID_INDEX");const n=this.node.get(i);if(!n)throw new Error("OUT_OF_BOUNDS");return this.api.wrap(n).proxy()}})}}class mi extends Q{get(t){return this.in(t)}set(t){const{api:e,node:s}=this,{builder:r}=e;return r.insObj(s.id,Object.entries(t).map(([i,n])=>[i,r.constOrJson(n)])),e.apply(),this}del(t){const{api:e,node:s}=this,{builder:r}=e;return e.builder.insObj(s.id,t.map(i=>[i,r.const(void 0)])),e.apply(),this}proxy(){return new Proxy({},{get:(e,s,r)=>{if(s==="toApi")return()=>this;if(s==="toView")return()=>this.view();const i=String(s),n=this.node.get(i);if(!n)throw new Error("NO_SUCH_KEY");return this.api.wrap(n).proxy()}})}}class ki extends Q{ins(t,e){const{api:s,node:r}=this;s.onBeforeLocalChange.emit(s.next);const i=s.builder;i.pad();const n=s.builder.nextTime(),c=new O(i.clock.sid,n),a=r.insAt(t,c,e);if(!a)throw new Error("OUT_OF_BOUNDS");return i.insStr(r.id,a,e),s.advance(),this}del(t,e){const{api:s,node:r}=this;s.onBeforeLocalChange.emit(s.next);const i=s.builder;i.pad();const n=r.findInterval(t,e);if(!n)throw new Error("OUT_OF_BOUNDS");return r.delete(n),i.del(r.id,n),s.advance(),this}findId(t){const e=this.node,r=e.length()-1;return t>r&&(t=r),t<0?e.id:e.find(t)||e.id}findPos(t){const e=this.node,s=e.id;if(s.sid===t.sid&&s.time===t.time)return-1;const r=e.findById(t);return r?e.pos(r)+(r.del?0:t.time-r.id.time):-1}length(){return this.node.length()}proxy(){return{toApi:()=>this,toView:()=>this.node.view()}}}class _i extends Q{ins(t,e){const{api:s,node:r}=this,i=t?r.find(t-1):r.id;if(!i)throw new Error("OUT_OF_BOUNDS");return s.builder.insBin(r.id,i,e),s.apply(),this}del(t,e){const{api:s,node:r}=this,i=r.findInterval(t,e);if(!i)throw new Error("OUT_OF_BOUNDS");return s.builder.del(r.id,i),s.apply(),this}length(){return this.node.length()}proxy(){return{toApi:()=>this,toView:()=>this.node.view()}}}class Oi extends Q{get(t){return this.in(t)}ins(t,e){const{api:s,node:r}=this,{builder:i}=s,n=t?r.find(t-1):r.id;if(!n)throw new Error("OUT_OF_BOUNDS");const c=[];for(let a=0;a<e.length;a++)c.push(i.json(e[a]));return i.insArr(r.id,n,c),s.apply(),this}del(t,e){const{api:s,node:r}=this,i=r.findInterval(t,e);if(!i)throw new Error("OUT_OF_BOUNDS");return s.builder.del(r.id,i),s.apply(),this}length(){return this.node.length()}proxy(){return new Proxy({},{get:(e,s,r)=>{if(s==="toApi")return()=>this;if(s==="toView")return()=>this.view();const i=Number(s);if(Number.isNaN(i))throw new Error("INVALID_INDEX");const n=this.node.getNode(i);if(!n)throw new Error("OUT_OF_BOUNDS");return this.api.wrap(n).proxy()}})}}const de=typeof Buffer=="function"?o=>o instanceof Uint8Array||Buffer.isBuffer(o):o=>o instanceof Uint8Array;let Si=class extends Ps{constructor(e=new xe){super(e);l(this,"writer");l(this,"patchSid",0);this.writer=e}encode(e){this.writer.reset();const s=e.getId(),r=this.patchSid=s.sid,i=this.writer;i.vu57(r),i.vu57(s.time);const n=e.meta;return n===void 0?this.writeUndef():this.writeArr([n]),this.encodeOperations(e),i.flush()}encodeOperations(e){const s=e.ops,r=s.length;this.writer.vu57(r);for(let i=0;i<r;i++)this.encodeOperation(s[i])}encodeId(e){const s=e.sid,r=e.time,i=this.writer;s===this.patchSid?i.b1vu56(0,r):(i.b1vu56(1,r),i.vu57(s))}encodeTss(e){this.encodeId(e),this.writer.vu57(e.span)}writeInsStr(e,s,r,i){const n=this.writer;return e<=7?n.u8(96+e):(n.u8(96),n.vu57(e)),this.encodeId(s),this.encodeId(r),n.utf8(i)}encodeOperation(e){const s=this.writer;switch(e.constructor){case It:{const n=e.val;n instanceof O?(s.u8(1),this.encodeId(n)):(s.u8(0),this.writeAny(n));break}case Nt:{s.u8(8);break}case At:{s.u8(16);break}case $t:{s.u8(24);break}case Et:{s.u8(32);break}case Tt:{s.u8(40);break}case Bt:{s.u8(48);break}case et:{const i=e;s.u8(72),this.encodeId(i.obj),this.encodeId(i.val);break}case Dt:{const i=e,n=i.data,c=n.length;c<=7?s.u8(80+c):(s.u8(80),s.vu57(c)),this.encodeId(i.obj);for(let a=0;a<c;a++){const h=n[a];this.writeStr(h[0]),this.encodeId(h[1])}break}case we:{const i=e,n=i.data,c=n.length;c<=7?s.u8(88+c):(s.u8(88),s.vu57(c)),this.encodeId(i.obj);for(let a=0;a<c;a++){const h=n[a];s.u8(h[0]),this.encodeId(h[1])}break}case Ut:{const i=e,n=i.obj,c=i.ref,a=i.data,h=a.length;s.ensureCapacity(24+h*4);const d=s.x,u=this.writeInsStr(h,n,c,a);h!==u&&(s.x=d,this.writeInsStr(u,n,c,a));break}case Pt:{const i=e,n=i.data,c=n.length;c<=7?s.u8(104+c):(s.u8(104),s.vu57(c)),this.encodeId(i.obj),this.encodeId(i.ref),s.buf(n,c);break}case Rt:{const i=e,n=i.data,c=n.length;c<=7?s.u8(112+c):(s.u8(112),s.vu57(c)),this.encodeId(i.obj),this.encodeId(i.ref);for(let a=0;a<c;a++)this.encodeId(n[a]);break}case Vt:{const i=e,n=i.what,c=n.length;c<=7?s.u8(128+c):(s.u8(128),s.vu57(c)),this.encodeId(i.obj);for(let a=0;a<c;a++)this.encodeTss(n[a]);break}case Lt:{const n=e.len;n<=7?s.u8(136+n):(s.u8(136),s.vu57(n));break}default:throw new Error("UNKNOWN_OP")}}},ji=class extends Fs{readAsMap(){const t=this.reader.u8(),e=t>>5,s=t&31;switch(e){case 5:return this.readMap(s);default:throw 0}}readMap(t){const e=this.readMinorLen(t);return e>=0?this.readMapRaw(e):this.readMapIndef()}readMapRaw(t){const e=new Map;for(let s=0;s<t;s++){const r=this.val(),i=this.val();e.set(r,i)}return e}readMapIndef(){const t=new Map;for(;this.reader.peak()!==255;){const e=this.val();if(this.reader.peak()===255)throw 7;const s=this.val();t.set(e,s)}return this.reader.x++,t}skipN(t){for(let e=0;e<t;e++)this.skipAny()}skipAny(){this.skipAnyRaw(this.reader.u8())}skipAnyRaw(t){const e=t>>5,s=t&31;switch(e){case 0:case 1:this.skipUNint(s);break;case 2:this.skipBin(s);break;case 3:this.skipStr(s);break;case 4:this.skipArr(s);break;case 5:this.skipObj(s);break;case 7:this.skipTkn(s);break;case 6:this.skipTag(s);break}}skipMinorLen(t){if(t<=23)return t;switch(t){case 24:return this.reader.u8();case 25:return this.reader.u16();case 26:return this.reader.u32();case 27:return Number(this.reader.u64());case 31:return-1;default:throw 1}}skipUNint(t){if(!(t<=23))switch(t){case 24:return this.reader.skip(1);case 25:return this.reader.skip(2);case 26:return this.reader.skip(4);case 27:return this.reader.skip(8);default:throw 1}}skipBin(t){const e=this.skipMinorLen(t);if(e>=0)this.reader.skip(e);else{for(;this.reader.peak()!==255;)this.skipBinChunk();this.reader.x++}}skipBinChunk(){const t=this.reader.u8(),e=t>>5,s=t&31;if(e!==2)throw 2;if(s>27)throw 3;this.skipBin(s)}skipStr(t){const e=this.skipMinorLen(t);if(e>=0)this.reader.skip(e);else{for(;this.reader.peak()!==255;)this.skipStrChunk();this.reader.x++}}skipStrChunk(){const t=this.reader.u8(),e=t>>5,s=t&31;if(e!==3)throw 4;if(s>27)throw 5;this.skipStr(s)}skipArr(t){const e=this.skipMinorLen(t);if(e>=0)this.skipN(e);else{for(;this.reader.peak()!==255;)this.skipAny();this.reader.x++}}skipObj(t){const e=this.readMinorLen(t);if(e>=0)return this.skipN(e*2);for(;this.reader.peak()!==255;){if(this.skipAny(),this.reader.peak()===255)throw 7;this.skipAny()}this.reader.x++}skipTag(t){if(this.skipMinorLen(t)<0)throw 1;this.skipAny()}skipTkn(t){switch(t){case 24:this.reader.skip(1);return;case 25:this.reader.skip(2);return;case 26:this.reader.skip(4);return;case 27:this.reader.skip(8);return}if(!(t<=23))throw 1}validate(t,e=0,s=t.length){this.reader.reset(t),this.reader.x=e;const r=e;if(this.skipAny(),this.reader.x-r!==s)throw 8}decodeLevel(t){return this.reader.reset(t),this.readLevel()}readLevel(){const t=this.reader.u8(),e=t>>5,s=t&31;switch(e){case 4:return this.readArrLevel(s);case 5:return this.readObjLevel(s);default:return super.readAnyRaw(t)}}readPrimitiveOrVal(){switch(this.reader.peak()>>5){case 4:case 5:return this.readAsValue();default:return this.val()}}readAsValue(){const t=this.reader,e=t.x;this.skipAny();const s=t.x;return new ue(t.uint8.subarray(e,s))}readObjLevel(t){const e=this.readMinorLen(t);return e>=0?this.readObjRawLevel(e):this.readObjIndefLevel()}readObjRawLevel(t){const e={};for(let s=0;s<t;s++){const r=this.key(),i=this.readPrimitiveOrVal();e[r]=i}return e}readObjIndefLevel(){const t={};for(;this.reader.peak()!==255;){const e=this.key();if(this.reader.peak()===255)throw 7;const s=this.readPrimitiveOrVal();t[e]=s}return this.reader.x++,t}readArrLevel(t){const e=this.readMinorLen(t);return e>=0?this.readArrRawLevel(e):this.readArrIndefLevel()}readArrRawLevel(t){const e=[];for(let s=0;s<t;s++)e.push(this.readPrimitiveOrVal());return e}readArrIndefLevel(){const t=[];for(;this.reader.peak()!==255;)t.push(this.readPrimitiveOrVal());return this.reader.x++,t}readHdr(t){const e=this.reader.u8();if(e>>5!==t)throw 0;const r=e&31;if(r<24)return r;switch(r){case 24:return this.reader.u8();case 25:return this.reader.u16();case 26:return this.reader.u32();case 27:return Number(this.reader.u64());case 31:return-1}throw 1}readStrHdr(){return this.readHdr(3)}readObjHdr(){return this.readHdr(5)}readArrHdr(){return this.readHdr(4)}findKey(t){const e=this.readObjHdr();for(let s=0;s<e;s++){if(this.key()===t)return this;this.skipAny()}throw 9}findIndex(t){const e=this.readArrHdr();if(t>=e)throw 10;for(let s=0;s<t;s++)this.skipAny();return this}find(t){for(let e=0;e<t.length;e++){const s=t[e];typeof s=="string"?this.findKey(s):this.findIndex(s)}return this}},Ci=class extends ji{constructor(e=new Ls){super(e);l(this,"builder");l(this,"patchSid")}decode(e){const s=this.reader;s.reset(e);const r=s.vu57(),i=s.vu57(),c=r===1?new Xt(1,i):new W(r,i);this.patchSid=c.sid;const a=this.builder=new Js(c),h=this.val();return h instanceof Array&&(a.patch.meta=h[0]),this.decodeOperations(),a.patch}decodeId(){const e=this.reader,[s,r]=e.b1vu56();return s?new O(e.vu57(),r):new O(this.patchSid,r)}decodeTss(){const e=this.decodeId(),s=this.reader.vu57();return Dr(e,0,s)}decodeOperations(){const s=this.reader.vu57();for(let r=0;r<s;r++)this.decodeOperation()}decodeOperation(){const e=this.builder,s=this.reader,r=s.u8();switch(r>>3){case 0:{const n=r&7;e.const(n?this.decodeId():this.val());break}case 1:{e.val();break}case 2:{e.obj();break}case 3:{e.vec();break}case 4:{e.str();break}case 5:{e.bin();break}case 6:{e.arr();break}case 9:{const n=this.decodeId(),c=this.decodeId();e.setVal(n,c);break}case 10:{const n=r&7||s.vu57(),c=this.decodeId(),a=[];for(let h=0;h<n;h++){const d=this.val();if(typeof d!="string")continue;const u=this.decodeId();a.push([d,u])}e.insObj(c,a);break}case 11:{const n=r&7||s.vu57(),c=this.decodeId(),a=[];for(let h=0;h<n;h++){const d=this.val();if(typeof d!="number")continue;const u=this.decodeId();a.push([d,u])}e.insVec(c,a);break}case 12:{const n=r&7||s.vu57(),c=this.decodeId(),a=this.decodeId(),h=s.utf8(n);e.insStr(c,a,h);break}case 13:{const n=r&7||s.vu57(),c=this.decodeId(),a=this.decodeId(),h=s.buf(n);if(!(h instanceof Uint8Array))return;e.insBin(c,a,h);break}case 14:{const n=r&7||s.vu57(),c=this.decodeId(),a=this.decodeId(),h=[];for(let d=0;d<n;d++)h.push(this.decodeId());e.insArr(c,a,h);break}case 16:{const n=r&7||s.vu57(),c=this.decodeId(),a=[];for(let h=0;h<n;h++)a.push(this.decodeTss());e.del(c,a);break}case 17:{const n=r&7||s.vu57();e.nop(n);break}default:throw new Error("UNKNOWN_OP")}}};const Ii=new xe(1024*4),Ni=new Si(Ii),Ai=o=>Ni.encode(o),$i=new Ci,Ei=o=>$i.decode(o);let Ve=class qs{constructor(){l(this,"ops",[]);l(this,"meta")}static fromBinary(t){return Ei(t)}getId(){const t=this.ops[0];if(t)return t.id}span(){let t=0;for(const e of this.ops)t+=e.span();return t}nextTime(){const t=this.ops,e=t.length;if(!e)return 0;const s=t[e-1];return s.id.time+s.span()}rewriteTime(t){const e=new qs,s=this.ops,r=s.length,i=e.ops;for(let n=0;n<r;n++){const c=s[n];c instanceof Vt?i.push(new Vt(t(c.id),t(c.obj),c.what)):c instanceof It?i.push(new It(t(c.id),c.val)):c instanceof $t?i.push(new $t(t(c.id))):c instanceof Nt?i.push(new Nt(t(c.id))):c instanceof At?i.push(new At(t(c.id))):c instanceof Et?i.push(new Et(t(c.id))):c instanceof Tt?i.push(new Tt(t(c.id))):c instanceof Bt?i.push(new Bt(t(c.id))):c instanceof Rt?i.push(new Rt(t(c.id),t(c.obj),t(c.ref),c.data.map(t))):c instanceof Ut?i.push(new Ut(t(c.id),t(c.obj),t(c.ref),c.data)):c instanceof Pt?i.push(new Pt(t(c.id),t(c.obj),t(c.ref),c.data)):c instanceof et?i.push(new et(t(c.id),t(c.obj),t(c.val))):c instanceof Dt?i.push(new Dt(t(c.id),t(c.obj),c.data.map(([a,h])=>[a,t(h)]))):c instanceof Lt&&i.push(new Lt(t(c.id),c.len))}return e}rebase(t,e){const s=this.getId();if(!s)throw new Error("EMPTY_PATCH");const r=s.time;if(r===t)return this;const i=t-r;return this.rewriteTime(n=>{if(!(n.sid===1))return n;const h=n.time;return h<e?n:A(1,h+i)})}clone(){return this.rewriteTime(t=>t)}toBinary(){return Ai(this)}toString(t=""){const e=this.getId();let s=`${this.constructor.name} ${e?m(e):"(nil)"}!${this.span()}`;for(let r=0;r<this.ops.length;r++){const i=r===this.ops.length-1;s+=`
${t}${i?"└─":"├─"} ${this.ops[r].toString(t+(i?"  ":"│ "))}`}return s}};const st=A(0,0);class Ti{constructor(t){l(this,"slots");this.slots=t}}let Bi=class{constructor(t){l(this,"val");this.val=t}};class B{constructor(t){l(this,"build");this.build=t}}const Le=o=>{switch(typeof o){case"number":case"boolean":return!0;default:return o===null}};let Js=class{constructor(t){l(this,"clock");l(this,"patch");this.clock=t,this.patch=new Ve}nextTime(){return this.patch.nextTime()||this.clock.time}flush(){const t=this.patch;return this.patch=new Ve,t}obj(){this.pad();const t=this.clock.tick(1);return this.patch.ops.push(new At(t)),t}arr(){this.pad();const t=this.clock.tick(1);return this.patch.ops.push(new Bt(t)),t}vec(){this.pad();const t=this.clock.tick(1);return this.patch.ops.push(new $t(t)),t}str(){this.pad();const t=this.clock.tick(1);return this.patch.ops.push(new Et(t)),t}bin(){this.pad();const t=this.clock.tick(1);return this.patch.ops.push(new Tt(t)),t}const(t){this.pad();const e=this.clock.tick(1);return this.patch.ops.push(new It(e,t)),e}val(){this.pad();const t=this.clock.tick(1);return this.patch.ops.push(new Nt(t)),t}root(t){this.pad();const e=this.clock.tick(1);return this.patch.ops.push(new et(e,st,t)),e}insObj(t,e){if(this.pad(),!e.length)throw new Error("EMPTY_TUPLES");const s=this.clock.tick(1),r=new Dt(s,t,e),i=r.span();return i>1&&this.clock.tick(i-1),this.patch.ops.push(r),s}insVec(t,e){if(this.pad(),!e.length)throw new Error("EMPTY_TUPLES");const s=this.clock.tick(1),r=new we(s,t,e),i=r.span();return i>1&&this.clock.tick(i-1),this.patch.ops.push(r),s}setVal(t,e){this.pad();const s=this.clock.tick(1),r=new et(s,t,e);return this.patch.ops.push(r),s}insStr(t,e,s){if(this.pad(),!s.length)throw new Error("EMPTY_STRING");const r=this.clock.tick(1),i=new Ut(r,t,e,s),n=i.span();return n>1&&this.clock.tick(n-1),this.patch.ops.push(i),r}insBin(t,e,s){if(this.pad(),!s.length)throw new Error("EMPTY_BINARY");const r=this.clock.tick(1),i=new Pt(r,t,e,s),n=i.span();return n>1&&this.clock.tick(n-1),this.patch.ops.push(i),r}insArr(t,e,s){this.pad();const r=this.clock.tick(1),i=new Rt(r,t,e,s),n=i.span();return n>1&&this.clock.tick(n-1),this.patch.ops.push(i),r}del(t,e){this.pad();const s=this.clock.tick(1);return this.patch.ops.push(new Vt(s,t,e)),s}nop(t){this.pad();const e=this.clock.tick(t);return this.patch.ops.push(new Lt(e,t)),e}jsonObj(t){const e=this.obj(),s=Object.keys(t);if(s.length){const r=[];for(const i of s){const n=t[i],c=n instanceof O?n:Le(n)?this.const(n):this.json(n);r.push([i,c])}this.insObj(e,r)}return e}jsonArr(t){const e=this.arr();if(t.length){const s=[];for(const r of t)s.push(this.json(r));this.insArr(e,e,s)}return e}jsonStr(t){const e=this.str();return t&&this.insStr(e,e,t),e}jsonBin(t){const e=this.bin();return t.length&&this.insBin(e,e,t),e}jsonVal(t){const e=this.val(),s=this.const(t);return this.setVal(e,s),e}jsonVec(t){const e=this.vec(),s=t.length;if(s){const r=[];for(let i=0;i<s;i++)r.push([i,this.constOrJson(t[i])]);this.insVec(e,r)}return e}json(t){if(t instanceof O)return t;if(t===void 0)return this.const(t);if(t instanceof Array)return this.jsonArr(t);if(de(t))return this.jsonBin(t);if(t instanceof Ti)return this.jsonVec(t.slots);if(t instanceof Bi)return this.const(t.val);if(t instanceof B)return t.build(this);switch(typeof t){case"object":return t===null?this.jsonVal(t):this.jsonObj(t);case"string":return this.jsonStr(t);case"number":case"boolean":return this.jsonVal(t)}throw new Error("INVALID_JSON")}constOrJson(t){return t instanceof O?t:Le(t)?this.const(t):this.json(t)}maybeConst(t){return t instanceof O?t:this.const(t)}pad(){const t=this.patch.nextTime();if(!t)return;const e=this.clock.time-t;if(e>0){const s=A(this.clock.sid,t),r=new Lt(s,e);this.patch.ops.push(r)}}};class Di{constructor(t){l(this,"model");l(this,"builder");l(this,"next",0);l(this,"onBeforeReset",new j);l(this,"onReset",new j);l(this,"onBeforePatch",new j);l(this,"onPatch",new j);l(this,"onBeforeLocalChange",new j);l(this,"onLocalChange",new j);l(this,"onLocalChanges",new Pe(this.onLocalChange));l(this,"onBeforeTransaction",new j);l(this,"onTransaction",new j);l(this,"onChange",new bi([this.onReset,this.onPatch,this.onLocalChange]));l(this,"onChanges",new Pe(this.onChange));l(this,"onFlush",new j);l(this,"stopAutoFlush");l(this,"subscribe",t=>this.onChanges.listen(()=>t()));l(this,"getSnapshot",()=>this.view());this.model=t,this.builder=new Js(t.clock),t.onbeforereset=()=>this.onBeforeReset.emit(),t.onreset=()=>this.onReset.emit(),t.onbeforepatch=e=>this.onBeforePatch.emit(e),t.onpatch=e=>this.onPatch.emit(e)}wrap(t){if(t instanceof P)return t.api||(t.api=new Re(t,this));if(t instanceof U)return t.api||(t.api=new ki(t,this));if(t instanceof D)return t.api||(t.api=new _i(t,this));if(t instanceof $)return t.api||(t.api=new Oi(t,this));if(t instanceof V)return t.api||(t.api=new mi(t,this));if(t instanceof L)return t.api||(t.api=new gi(t,this));if(t instanceof R)return t.api||(t.api=new vi(t,this));throw new Error("UNKNOWN_NODE")}get r(){return new Re(this.model.root,this)}get node(){return this.r.get()}in(t){return this.r.in(t)}find(t){return this.node.find(t)}val(t){return this.node.val(t)}vec(t){return this.node.tup(t)}str(t){return this.node.str(t)}bin(t){return this.node.bin(t)}arr(t){return this.node.arr(t)}obj(t){return this.node.obj(t)}const(t){return this.node.const(t)}root(t){const e=this.builder;return e.root(e.json(t)),this.apply(),this}apply(){const t=this.builder.patch.ops,e=t.length,s=this.model,r=this.next;this.onBeforeLocalChange.emit(r);for(let i=this.next;i<e;i++)s.applyOperation(t[i]);this.next=e,s.tick++,this.onLocalChange.emit(r)}advance(){const t=this.next;this.next=this.builder.patch.ops.length,this.model.tick++,this.onLocalChange.emit(t)}view(){return this.model.view()}transaction(t){this.onBeforeTransaction.emit(),t(),this.onTransaction.emit()}flush(){const t=this.builder.flush();return this.next=0,this.onFlush.emit(t),t}autoFlush(){const t=()=>this.builder.patch.ops.length&&this.flush(),e=this.onLocalChanges.listen(t),s=this.onBeforeTransaction.listen(t),r=this.onTransaction.listen(t);return this.stopAutoFlush=()=>{this.stopAutoFlush=void 0,e(),s(),r()}}}const Hs=65535,Ui=9007199254740991-Hs,Me=()=>Math.floor(Ui*Math.random()+Hs);class me{constructor(){l(this,"ext",{})}register(t){this.ext[t.id]=t}get(t){return this.ext[t]}size(){return Object.keys(this.ext).length}clone(){const t=new me;for(const e of Object.values(this.ext))t.register(e);return t}toString(t=""){const e=Object.keys(this.ext).map(s=>+s).sort();return"extensions"+C(t,e.map(s=>r=>`${s}: ${this.ext[s].name}`))}}const Ct=(o,t=" ")=>{switch(o){case null:return"!n";case void 0:return"!u";case!0:return"!t";case!1:return"!f"}if(Array.isArray(o))return`[${t}${o.map(e=>Ct(e,t)).join(","+t)}${t}]`;if(o instanceof Uint8Array)return`${o}`;switch(typeof o){case"number":return`${o}`;case"string":return JSON.stringify(o);case"object":{const e=Object.keys(o);return`{${t}${e.map(s=>`${s}${t}=${t}${Ct(o[s],t)}`).join(","+t)}${t}}`}}return"?"},ke=(o="",t)=>{const[e,s]=t;let r="";return e&&(r+=`
${o}← ${e(o+"  ")}`),s&&(r+=`
${o}→ ${s(o+"  ")}`),r},_e=(o,t,e)=>{const s=t.p;if(!s)return o;const r=t===s.l;let i=s.bf|0;switch(r?s.bf=++i:s.bf=--i,i){case 0:return o;case 1:case-1:return _e(o,s,t);default:{const n=e===t.l;return r?n?(Qt(s,t),t.p?o:t):(Ws(s,t,e),e.p?o:e):n?(Oe(s,t,e),e.p?o:e):(Mt(s,t),t.p?o:t)}}},Qt=(o,t)=>{const e=o.p,s=t.r;t.p=e,t.r=o,o.p=t,o.l=s,s&&(s.p=o),e&&(e.l===o?e.l=t:e.r=t);let r=o.bf,i=t.bf;r+=-1-(i>0?i:0),i+=-1+(r<0?r:0),o.bf=r,t.bf=i},Mt=(o,t)=>{const e=o.p,s=t.l;t.p=e,t.l=o,o.p=t,o.r=s,s&&(s.p=o),e&&(e.l===o?e.l=t:e.r=t);let r=o.bf,i=t.bf;r+=1-(i<0?i:0),i+=1+(r>0?r:0),o.bf=r,t.bf=i},Ws=(o,t,e)=>{Mt(t,e),Qt(o,e)},Oe=(o,t,e)=>{Qt(t,e),Mt(o,e)},Ks=(o,t,e)=>(e.r=t,t.p=e,e.bf--,e.l?o:_e(o,e,t)),zs=(o,t,e)=>(e.l=t,t.p=e,e.bf++,e.r?o:_e(o,e,t)),Pi=(o,t,e)=>{if(!o)return t;const s=t.k;let r=o,i,n=0;for(;i=(n=e(s,r.k))<0?r.l:r.r;)r=i;return n<0?zs(o,t,r):Ks(o,t,r)},Ri=(o,t)=>{if(!o)return t;const e=t.p,s=t.l,r=t.r;if(t.p=t.l=t.r=void 0,s&&r)if(s.r){let c=s,a=c;for(;a=c.r;)c=a;const h=c.l,d=c.p,u=h;return e&&(e.l===t?e.l=c:e.r=c),c.p=e,c.r=r,c.bf=t.bf,s!==c&&(c.l=s,s.p=c),r.p=c,d&&(d.l===c?d.l=u:d.r=u),u&&(u.p=d),zt(e?o:c,d,1)}else{e&&(e.l===t?e.l=s:e.r=s),s.p=e,s.r=r,r.p=s;const c=t.bf;if(e)return s.bf=c,Kt(o,s,1);const a=c-1;if(s.bf=a,a>=-1)return s;const h=r.l;return r.bf>0?(Oe(s,r,h),h):(Mt(s,r),r)}const i=s||r;return i&&(i.p=e),e?e.l===t?(e.l=i,Kt(o,e,1)):(e.r=i,zt(o,e,1)):i},Kt=(o,t,e)=>{let s=t.bf|0;s-=e,t.bf=s;let r=e;if(s===-1)return o;if(s<-1){const n=t.r;if(n.bf<=0)n.l&&n.bf===0&&(r=0),Mt(t,n),t=n;else{const c=n.l;Oe(t,n,c),t=c}}const i=t.p;return i?i.l===t?Kt(o,i,r):zt(o,i,r):t},zt=(o,t,e)=>{let s=t.bf|0;s+=e,t.bf=s;let r=e;if(s===1)return o;if(s>1){const n=t.l;if(n.bf>=0)n.r&&n.bf===0&&(r=0),Qt(t,n),t=n;else{const c=n.r;Ws(t,n,c),t=c}}const i=t.p;return i?i.l===t?Kt(o,i,r):zt(o,i,r):t},fe=(o,t="")=>{if(!o)return"∅";const{bf:e,l:s,r,k:i,v:n}=o,c=n&&typeof n=="object"&&n.constructor===Object?Ct(n):n&&typeof n=="object"?n.toString(t):Ct(n),a=i!==void 0?` { ${Ct(i)} = ${c} }`:"",h=e?` [${e}]`:"";return o.constructor.name+`${h}`+a+ke(t,[s?d=>fe(s,d):null,r?d=>fe(r,d):null])},Fe=o=>{let t=o;for(;t;)if(t.l)t=t.l;else return t;return t},le=o=>{if(o.r){for(o=o.r;o.l;)o=o.l;return o}let t=o.p;for(;t&&t.r===o;)o=t,t=t.p;return t},Vi=(o,t,e)=>{let s=o,r;for(;s;){const i=e(s.k,t);if(i===0)return s;if(i>0)s=s.l;else{const n=s.r;if(r=s,!n)return r;s=n}}return r};class qe{constructor(t,e){l(this,"k");l(this,"v");l(this,"p");l(this,"l");l(this,"r");l(this,"bf",0);this.k=t,this.v=e}}const Li=(o,t)=>o===t?0:o<t?-1:1;class Je{constructor(t){l(this,"root");l(this,"comparator");this.comparator=t||Li}insert(t,e){const s=new qe(t,e);return this.root=Pi(this.root,s,this.comparator),s}set(t,e){const s=this.root;if(!s)return this.insert(t,e);const r=this.comparator;let i=s,n=i,c=0;do if(n=i,c=r(t,n.k),c===0)return n.v=e,n;while(i=c<0?n.l:n.r);const a=new qe(t,e);return this.root=c<0?zs(s,a,n):Ks(s,a,n),a}find(t){const e=this.comparator;let s=this.root;for(;s;){const r=e(t,s.k);if(r===0)return s;s=r<0?s.l:s.r}}get(t){var e;return(e=this.find(t))==null?void 0:e.v}del(t){const e=this.find(t);return e?(this.root=Ri(this.root,e),!0):!1}clear(){this.root=void 0}has(t){return!!this.find(t)}size(){const t=this.root;if(!t)return 0;let e=Fe(t),s=1;for(;e=le(e);)s++;return s}isEmpty(){return!this.root}getOrNextLower(t){return Vi(this.root,t,this.comparator)||void 0}forEach(t){const e=this.root;if(!e)return;let s=Fe(e);do t(s);while(s=le(s))}toString(t){return this.constructor.name+C(t,[e=>fe(this.root,e)])}}const Ys=new L(st,void 0);class K{constructor(t){l(this,"root",new Gs(this,st));l(this,"clock");l(this,"index",new Je(X));l(this,"ext",new me);l(this,"_api");l(this,"tick",0);l(this,"onbeforepatch");l(this,"onpatch");l(this,"onbeforereset");l(this,"onreset");this.clock=t,t.time||(t.time=1)}static withLogicalClock(t){const e=typeof t=="number"?new W(t,1):t||new W(Me(),1);return new K(e)}static withServerClock(t=0){const e=new Xt(1,t);return new K(e)}static fromBinary(t){return Ue.decode(t)}get api(){return this._api||(this._api=new Di(this)),this._api}get find(){return this.api.r.proxy()}get s(){return this.api.r.proxy().val}applyBatch(t){const e=t.length;for(let s=0;s<e;s++)this.applyPatch(t[s])}applyPatch(t){var r,i;(r=this.onbeforepatch)==null||r.call(this,t);const e=t.ops,{length:s}=e;for(let n=0;n<s;n++)this.applyOperation(e[n]);this.tick++,(i=this.onpatch)==null||i.call(this,t)}applyOperation(t){this.clock.observe(t.id,t.span());const e=this.index;if(t instanceof Ut){const s=e.get(t.obj);s instanceof U&&s.ins(t.ref,t.id,t.data)}else if(t instanceof At){const s=t.id;e.get(s)||e.set(s,new V(this,s))}else if(t instanceof Bt){const s=t.id;e.get(s)||e.set(s,new $(this,s))}else if(t instanceof Et){const s=t.id;e.get(s)||e.set(s,new U(s))}else if(t instanceof Nt){const s=t.id;e.get(s)||e.set(s,new P(this,s,st))}else if(t instanceof It){const s=t.id;e.get(s)||e.set(s,new L(s,t.val))}else if(t instanceof Dt){const s=e.get(t.obj),r=t.data,i=r.length;if(s instanceof V)for(let n=0;n<i;n++){const c=r[n],a=e.get(c[1]);if(!a||s.id.time>=c[1].time)continue;const h=s.put(c[0]+"",a.id);h&&this.deleteNodeTree(h)}}else if(t instanceof we){const s=e.get(t.obj),r=t.data,i=r.length;if(s instanceof R)for(let n=0;n<i;n++){const c=r[n],a=e.get(c[1]);if(!a||s.id.time>=c[1].time)continue;const h=s.put(Number(c[0]),a.id);h&&this.deleteNodeTree(h)}}else if(t instanceof et){const s=t.obj,r=s.sid===0&&s.time===0?this.root:e.get(s);if(r instanceof P&&e.get(t.val)){const n=r.set(t.val);n&&this.deleteNodeTree(n)}}else if(t instanceof Rt){const s=e.get(t.obj);if(s instanceof $){const r=[],i=t.data,n=i.length;for(let c=0;c<n;c++){const a=i[c];e.get(a)&&(s.id.time>=a.time||r.push(a))}r.length&&s.ins(t.ref,t.id,r)}}else if(t instanceof Vt){const s=e.get(t.obj);if(s instanceof $){const r=t.what.length;for(let i=0;i<r;i++){const n=t.what[i];for(let c=0;c<n.span;c++){const a=s.getById(new O(n.sid,n.time+c));a&&this.deleteNodeTree(a)}}s.delete(t.what)}else(s instanceof U||s instanceof D)&&s.delete(t.what)}else if(t instanceof Tt){const s=t.id;e.get(s)||e.set(s,new D(s))}else if(t instanceof Pt){const s=e.get(t.obj);s instanceof D&&s.ins(t.ref,t.id,t.data)}else if(t instanceof $t){const s=t.id;e.get(s)||e.set(s,new R(this,s))}}deleteNodeTree(t){if(t.sid===0)return;const s=this.index.get(t);if(!s)return;const r=s.api;r&&r.events.handleDelete(),s.children(i=>this.deleteNodeTree(i.id)),this.index.del(t)}fork(t=Me()){const e=K.fromBinary(this.toBinary());return e.clock.sid!==t&&e.clock instanceof W&&(e.clock=e.clock.fork(t)),e.ext=this.ext,e}clone(){return this.fork(this.clock.sid)}reset(t){var r,i,n;(r=this.onbeforereset)==null||r.call(this);const e=this.index;this.index=new Je(X);const s=t.toBinary();Ue.decode(s,this),this.clock=t.clock.clone(),this.ext=t.ext.clone(),(i=this._api)==null||i.flush(),e.forEach(({v:c})=>{const a=c.api;if(!a)return;const h=this.index.get(c.id);if(!h){a.events.handleDelete();return}a.node=h,h.api=a}),this.tick++,(n=this.onreset)==null||n.call(this)}view(){return this.root.view()}toBinary(){return ci.encode(this)}setSchema(t){return this.clock.time<2&&this.api.root(t),this}toString(t=""){const e=()=>"",s=this.ext.size()>0;return"model"+C(t,[r=>this.root.toString(r),e,r=>{const i=[];return this.index.forEach(n=>i.push(n.v)),`index (${i.length} nodes)`+(i.length?C(r,i.map(n=>c=>`${n.name()} ${m(n.id)}`)):"")},e,r=>`view${C(r,[i=>String(JSON.stringify(this.view(),null,2)).replace(/\n/g,`
`+i)])}`,e,r=>this.clock.toString(r),s?e:null,s?r=>this.ext.toString(r):null])}}class P{constructor(t,e,s){l(this,"doc");l(this,"id");l(this,"val");l(this,"api");this.doc=t,this.id=e,this.val=s}set(t){if(X(t,this.val)<=0&&this.val.sid!==0||X(t,this.id)<=0)return;const e=this.val;return this.val=t,e}node(){return this.val.sid===0?Ys:this.child()}view(){var t;return(t=this.node())==null?void 0:t.view()}children(t){t(this.node())}child(){return this.doc.index.get(this.val)}container(){const t=this.node();return t?t.container():void 0}name(){return"val"}toString(t=""){const e=this.node();return this.name()+" "+m(this.id)+C(t,[r=>e?e.toString(r):m(this.val)])}}class Gs extends P{constructor(t,e){super(t,st,e)}name(){return"root"}}class R{constructor(t,e){l(this,"doc");l(this,"id");l(this,"elements",[]);l(this,"__extNode");l(this,"_view",[]);l(this,"api");this.doc=t,this.id=e}val(t){return this.elements[t]}get(t){const e=this.elements[t];if(e)return this.doc.index.get(e)}put(t,e){if(t>255)throw new Error("OUT_OF_BOUNDS");const s=this.val(t);if(!(s&&X(s,e)>=0)){if(t>this.elements.length)for(let r=this.elements.length;r<t;r++)this.elements.push(void 0);return t<this.elements.length?this.elements[t]=e:this.elements.push(e),s}}ext(){if(this.__extNode)return this.__extNode;const t=this.getExtId();if(!(t>=0))return;const s=this.doc.ext.get(t);if(s)return this.__extNode=new s.Node(this.get(1)),this.__extNode}isExt(){return!!this.ext()}getExtId(){if(this.elements.length!==2)return-1;const t=this.get(0);if(!(t instanceof L))return-1;const e=t.val,s=this.id;return!(e instanceof Uint8Array)||e.length!==3||e[1]!==s.sid%256||e[2]!==s.time%256?-1:e[0]}child(){return this.ext()}container(){return this}children(t){if(this.isExt())return;const e=this.elements,s=e.length,r=this.doc.index;for(let i=0;i<s;i++){const n=e[i];if(!n)continue;const c=r.get(n);c&&t(c)}}view(){const t=this.ext();if(t)return t.view();let e=!0;const s=this._view,r=[],i=this.doc.index,n=this.elements,c=n.length;for(let a=0;a<c;a++){const h=n[a],d=h?i.get(h):void 0,u=d?d.view():void 0;s[a]!==u&&(e=!1),r.push(u)}return e?s:this._view=r}name(){return"vec"}toString(t=""){const e=this.ext(),s=this.name()+" "+m(this.id)+(e?` { extension = ${this.getExtId()} }`:"");if(e)return this.child().toString(t);const r=this.doc.index;return s+C(t,[...this.elements.map((i,n)=>c=>`${n}: ${i&&r.get(i)?r.get(i).toString(c+"  "+" ".repeat((""+n).length)):"nil"}`),...e?[i=>`${this.child().toString(i)}`]:[]])}}class V{constructor(t,e){l(this,"doc");l(this,"id");l(this,"keys",new Map);l(this,"_tick",0);l(this,"_view",{});l(this,"api");this.doc=t,this.id=e}get(t){const e=this.keys.get(t);if(e)return this.doc.index.get(e)}put(t,e){const s=this.keys.get(t);if(!(s&&X(s,e)>=0))return this.keys.set(t,e),s}nodes(t){const e=this.doc.index;this.keys.forEach((s,r)=>t(e.get(s),r))}children(t){const e=this.doc.index;this.keys.forEach((s,r)=>t(e.get(s)))}child(){}container(){return this}view(){const t=this.doc,e=t.clock.time+t.tick,s=this._view;if(this._tick===e)return s;const r={},i=t.index;let n=!0;return this.keys.forEach((c,a)=>{const h=i.get(c);if(!h){n=!1;return}const d=h.view();d!==void 0?(s[a]!==d&&(n=!1),r[a]=d):s[a]!==void 0&&(n=!1)}),n?s:(this._tick=e,this._view=r)}name(){return"obj"}toString(t=""){return this.name()+" "+m(this.id)+C(t,[...this.keys.entries()].filter(([,s])=>!!this.doc.index.get(s)).map(([s,r])=>i=>JSON.stringify(s)+C(i+" ",[n=>this.doc.index.get(r).toString(n)])))}}const Mi=(o,t)=>{const e=o.r;o.p=void 0,o.r=t,t.p=o,t.l=e,e&&(e.p=t)},Fi=(o,t)=>{const e=o.l;o.p=void 0,o.l=t,t.p=o,t.r=e,e&&(e.p=t)},qi=(o,t,e,s)=>{const r=e.l,i=t.l,n=s.p;return t.p=n,t.l=e,e.p=t,e.l=s,e.r=i,s.p=e,s.r=r,r&&(r.p=s),i&&(i.p=e),n?n.l===s?n.l=t:n.r=t:o=t,o},Ji=(o,t,e,s)=>{const r=e.r,i=t.r,n=s.p;return t.p=n,t.r=e,e.p=t,e.l=i,e.r=s,s.p=e,s.l=r,r&&(r.p=s),i&&(i.p=e),n?n.l===s?n.l=t:n.r=t:o=t,o},Hi=(o,t,e,s)=>{const r=t.l,i=t.r,n=s.p;return t.p=n,t.l=e,t.r=s,e.p=t,e.r=r,s.p=t,s.l=i,r&&(r.p=e),i&&(i.p=s),n?n.l===s?n.l=t:n.r=t:o=t,o},Wi=(o,t,e,s)=>{const r=t.r,i=t.l,n=s.p;return t.p=n,t.l=s,t.r=e,e.p=t,e.l=r,s.p=t,s.r=i,r&&(r.p=e),i&&(i.p=s),n?n.l===s?n.l=t:n.r=t:o=t,o},Xs=(o,t)=>{const e=t.p2;if(!e)return o;const s=e.p2,r=e.l2===t;return s?(s.l2===e?r?o=Gi(o,t,e,s):o=Xi(o,t,e,s):r?o=Qi(o,t,e,s):o=Yi(o,t,e,s),Xs(o,t)):(r?Ki(t,e):zi(t,e),t)},Ki=(o,t)=>{const e=o.r2;o.p2=void 0,o.r2=t,t.p2=o,t.l2=e,e&&(e.p2=t)},zi=(o,t)=>{const e=o.l2;o.p2=void 0,o.l2=t,t.p2=o,t.r2=e,e&&(e.p2=t)},Yi=(o,t,e,s)=>{const r=e.l2,i=t.l2,n=s.p2;return t.p2=n,t.l2=e,e.p2=t,e.l2=s,e.r2=i,s.p2=e,s.r2=r,r&&(r.p2=s),i&&(i.p2=e),n?n.l2===s?n.l2=t:n.r2=t:o=t,o},Gi=(o,t,e,s)=>{const r=e.r2,i=t.r2,n=s.p2;return t.p2=n,t.r2=e,e.p2=t,e.l2=i,e.r2=s,s.p2=e,s.l2=r,r&&(r.p2=s),i&&(i.p2=e),n?n.l2===s?n.l2=t:n.r2=t:o=t,o},Xi=(o,t,e,s)=>{const r=t.l2,i=t.r2,n=s.p2;return t.p2=n,t.l2=e,t.r2=s,e.p2=t,e.r2=r,s.p2=t,s.l2=i,r&&(r.p2=e),i&&(i.p2=s),n?n.l2===s?n.l2=t:n.r2=t:o=t,o},Qi=(o,t,e,s)=>{const r=t.r2,i=t.l2,n=s.p2;return t.p2=n,t.l2=s,t.r2=e,e.p2=t,e.l2=r,s.p2=t,s.r2=i,r&&(r.p2=e),i&&(i.p2=s),n?n.l2===s?n.l2=t:n.r2=t:o=t,o},Zi=(o,t)=>{const e=o.r2=t.r2;t.r2=o,o.p2=t,e&&(e.p2=o)},tn=(o,t)=>{const e=o.l2=t.l2;t.l2=o,o.p2=t,e&&(e.p2=o)},He=(o,t,e)=>{if(!o)return t;let s=o;for(;s;){const r=e(t,s),i=r<0?s.l2:s.r2;if(i)s=i;else{r<0?tn(t,s):Zi(t,s);break}}return o},en=(o,t)=>{const e=t.p2,s=t.l2,r=t.r2;if(t.p2=t.l2=t.r2=void 0,!s&&!r){if(e)e.l2===t?e.l2=void 0:e.r2=void 0;else return;return o}else if(s&&r){let n=s;for(;n.r2;)n=n.r2;return n.r2=r,r.p2=n,e?(e.l2===t?e.l2=s:e.r2=s,s.p2=e,o):(s.p2=void 0,s)}const i=s||r;if(i.p2=e,e)e.l2===t?e.l2=i:e.r2=i;else return i;return o},We=(o,t=16)=>{let e="";if(!o.length)return e;o[0]<16&&(e+="0"),e+=o[0].toString(16);for(let s=1;s<o.length&&s<t;s++){const r=o[s];e+=" ",r<16&&(e+="0"),e+=r.toString(16)}return o.length>t&&(e+=`… (${o.length-t} more)`),e},Ke=(o,t)=>{const e=o.id,s=t.id;return e.sid-s.sid||e.time-s.time},N=o=>{const t=o.l,e=o.r;o.len=(o.del?0:o.span)+(t?t.len:0)+(e?e.len:0)},ze=o=>{const t=o.l,e=o.r;o.len=o.span+(t?t.len:0)+(e?e.len:0)},M=(o,t)=>{for(;o;)o.len+=t,o=o.p},I=o=>{const t=o.r;if(t){o=t;let s;for(;s=o.l;)o=s;return o}let e=o.p;for(;e&&e.r===o;)o=e,e=e.p;return e},sn=o=>{const t=o.l;if(t){o=t;let s;for(;s=o.r;)o=s;return o}let e=o.p;for(;e&&e.l===o;)o=e,e=e.p;return e};class Se{constructor(t){l(this,"id");l(this,"root");l(this,"ids");l(this,"count",0);this.id=t}ins(t,e,s){const r=this.id,i=t.time,n=t.sid;if(r.time===i&&r.sid===n){this.insAfterRoot(t,e,s);return}let a=this.ids,h=a;for(;a;){const w=a.id,y=w.sid;if(y>n)a=a.l2;else if(y<n)h=a,a=a.r2;else{const g=w.time;if(g>i)a=a.l2;else if(g<i)h=a,a=a.r2;else{h=a;break}}}if(!h)return;const d=h.id,u=d.time,f=d.sid,p=h.span;if(f!==n||i-u>=p)return;const b=i-u;this.insAfterChunk(t,h,b,e,s)}insAt(t,e,s){if(!t){const h=this.id;return this.insAfterRoot(h,e,s),h}const r=this.findChunk(t-1);if(!r)return;const[i,n]=r,c=i.id,a=n===0?c:new O(c.sid,c.time+n);return this.insAfterChunk(a,i,n,e,s),a}insAfterRoot(t,e,s){const r=this.createChunk(e,s),i=this.first();if(!i)this.setRoot(r);else if(X(i.id,e)<0)this.insertBefore(r,i);else{if(nt(i.id,i.span,e))return;this.insertAfterRef(r,t,i)}}insAfterChunk(t,e,s,r,i){const n=e.id,c=n.time,a=n.sid,h=e.span,d=this.createChunk(r,i);if(s+1<h){const f=r.sid,p=r.time;if(a===f&&c<=p&&c+h-1>=p)return;if(p>t.time+1||f>t.sid){this.insertInside(d,e,s+1),this.splay(d);return}}this.insertAfterRef(d,t,e),this.splay(d)}delete(t){const e=t.length;for(let s=0;s<e;s++)this.deleteSpan(t[s]);this.onChange()}deleteSpan(t){const e=t.span,s=t.time,r=s+e-1,i=this.findById(t);if(!i)return;let n=i,c=n;for(;n;){c=n;const a=n.id,h=n.span,d=a.time,u=d+h-1;if(n.del){if(u>=r)break;n=n.s;continue}const f=s<=d,p=s<=u;if(f)if(r>=u){if(n.delete(),M(n,-n.span),r<=u)break}else{const b=r-d+1,w=this.split(n,b);n.delete(),N(w),M(n,-n.span);break}else if(p)if(r>=u){const b=s-d,w=this.split(n,b);if(w.delete(),w.len=w.r?w.r.len:0,M(n,-w.span),r<=u)break}else{const b=this.split(n,r-d+1),w=this.split(n,s-d);w.delete(),N(b),N(w),M(n,-w.span);break}n=n.s}c&&this.mergeTombstones2(i,c)}find(t){let e=this.root;for(;e;){const s=e.l,r=s?s.len:0;let i;if(t<r)e=s;else if(e.del)t-=r,e=e.r;else if(t<r+(i=e.span)){const n=t-r,c=e.id;return n?new O(c.sid,c.time+n):c}else t-=r+i,e=e.r}}findChunk(t){let e=this.root;for(;e;){const s=e.l,r=s?s.len:0;let i;if(t<r)e=s;else if(e.del)t-=r,e=e.r;else{if(t<r+(i=e.span))return[e,t-r];t-=r+i,e=e.r}}}findInterval(t,e){const s=[];if(!e)return s;let r=this.root,i=0;for(;r;){const a=r.l?r.l.len:0;if(t<a)r=r.l;else if(r.del)t-=a,r=r.r;else if(t<a+r.span){i=t-a;break}else t-=a+r.span,r=r.r}if(!r)return s;if(r.span>=e+i){const a=r.id;return s.push(it(a.sid,a.time+i,e)),s}const n=r.span-i,c=r.id;if(s.push(it(c.sid,c.time+i,n)),e-=n,r=I(r),!r)return s;do{if(r.del)continue;const a=r.id,h=r.span;if(e<=h)return s.push(it(a.sid,a.time,e)),s;s.push(it(a.sid,a.time,h)),e-=h}while((r=I(r))&&e>0);return s}findInterval2(t,e){const s=[];return this.range0(void 0,t,e,(r,i,n)=>{const c=r.id;s.push(it(c.sid,c.time+i,n))}),s}range0(t,e,s,r){let i=t||this.findById(e);if(t)for(;i&&!nt(i.id,i.span,e);)i=I(i);if(i){if(i.del){if(nt(i.id,i.span,s))return}else{const n=e.time-i.id.time;if(nt(i.id,i.span,s)){const h=s.time-e.time+1;return r(i,n,h),i}const a=i.span-n;r(i,n,a)}for(i=I(i);i;){if(nt(i.id,i.span,s))return i.del||r(i,0,s.time-i.id.time+1),i;i.del||r(i,0,i.span),i=I(i)}return i}}first(){let t=this.root;for(;t;){const e=t.l;if(e)t=e;else return t}return t}last(){let t=this.root;for(;t;){const e=t.r;if(e)t=e;else return t}return t}lastId(){const t=this.last();if(!t)return;const e=t.id,s=t.span;return s===1?e:new O(e.sid,e.time+s-1)}next(t){return I(t)}length(){const t=this.root;return t?t.len:0}size(){return this.count}pos(t){const e=t.p,s=t.l;if(!e)return s?s.len:0;const r=this.pos(e);if(e.r===t)return r+(e.del?0:e.span)+(s?s.len:0);const n=t.r;return r-(t.del?0:t.span)-(n?n.len:0)}setRoot(t){this.root=t,this.insertId(t),this.onChange()}insertBefore(t,e){const s=e.l;e.l=t,t.l=s,t.p=e;let r=0;s&&(s.p=t,r=s.len),t.len=t.span+r,M(e,t.span),this.insertId(t),this.onChange()}insertAfter(t,e){const s=e.r;e.r=t,t.r=s,t.p=e;let r=0;s&&(s.p=t,r=s.len),t.len=t.span+r,M(e,t.span),this.insertId(t),this.onChange()}insertAfterRef(t,e,s){const r=t.id,i=r.sid,n=r.time;let c=!1;for(;;){const a=s.id,h=a.time+s.span;s.s||(c=a.sid===i&&h===n&&h-1===e.time,c&&(s.s=t));const d=I(s);if(!d)break;const u=d.id,f=u.time,p=u.sid;if(f<n)break;if(f===n){if(p===i)return;if(p<i)break}s=d}c&&!s.del?(this.mergeContent(s,t.data),s.s=void 0):this.insertAfter(t,s)}mergeContent(t,e){const s=t.span;t.merge(e),M(t,t.span-s),this.onChange()}insertInside(t,e,s){const r=e.p,i=e.l,n=e.r,c=e.s,a=e.len,h=e.split(s);if(e.s=h,h.s=c,e.l=e.r=h.l=h.r=void 0,h.l=void 0,t.p=r,!i)t.l=e,e.p=t;else{t.l=i,i.p=t;const f=i.r;i.r=e,e.p=i,e.l=f,f&&(f.p=e)}if(!n)t.r=h,h.p=t;else{t.r=n,n.p=t;const f=n.l;n.l=h,h.p=n,h.r=f,f&&(f.p=h)}r?r.l===e?r.l=t:r.r=t:this.root=t,N(e),N(h),i&&(i.len=(i.l?i.l.len:0)+e.len+(i.del?0:i.span)),n&&(n.len=(n.r?n.r.len:0)+h.len+(n.del?0:n.span)),t.len=a+t.span;const d=t.span;let u=t.p;for(;u;)u.len+=d,u=u.p;this.insertId(h),this.insertIdFast(t),this.onChange()}split(t,e){const s=t.s,r=t.split(e),i=t.r;return t.s=r,r.r=i,r.s=s,t.r=r,r.p=t,this.insertId(r),i&&(i.p=r),r}mergeTombstones(t,e){if(!t.del||!e.del)return!1;const s=t.id,r=e.id;return s.sid!==r.sid||s.time+t.span!==r.time?!1:(t.s=e.s,t.span+=e.span,this.deleteChunk(e),!0)}mergeTombstones2(t,e){let s=t;for(;s;){const i=I(s);if(!i)break;if(!this.mergeTombstones(s,i)){if(i===e){if(i){const c=I(i);c&&this.mergeTombstones(i,c)}break}s=s.s}}const r=sn(t);r&&this.mergeTombstones(r,t)}removeTombstones(){let t=this.first();const e=[];for(;t;)t.del&&e.push(t),t=I(t);for(let s=0;s<e.length;s++)this.deleteChunk(e[s])}deleteChunk(t){this.deleteId(t);const e=t.p,s=t.l,r=t.r;if(t.id=st,!s&&!r)e?e.l===t?e.l=void 0:e.r=void 0:this.root=void 0;else if(s&&r){let i=s;for(;i.r;)i=i.r;i.r=r,r.p=i;const n=r.len;let c;for(c=i,e?(e.l===t?e.l=s:e.r=s,s.p=e):(this.root=s,s.p=void 0);c&&c!==e;)c.len+=n,c=c.p}else{const i=s||r;i.p=e,e?e.l===t?e.l=i:e.r=i:this.root=i}}insertId(t){this.ids=He(this.ids,t,Ke),this.count++,this.ids=Xs(this.ids,t)}insertIdFast(t){this.ids=He(this.ids,t,Ke),this.count++}deleteId(t){this.ids=en(this.ids,t),this.count--}findById(t){const e=t.sid,s=t.time;let r=this.ids,i=r;for(;r;){const u=r.id,f=u.sid;if(f>e)r=r.l2;else if(f<e)i=r,r=r.r2;else{const p=u.time;if(p>s)r=r.l2;else if(p<s)i=r,r=r.r2;else{i=r;break}}}if(!i)return;const n=i.id,c=n.time,a=n.sid,h=i.span;if(!(a!==e||s<c||s-c>=h))return i}splay(t){const e=t.p;if(!e)return;const s=e.p,r=e.l===t;if(!s){r?Mi(t,e):Fi(t,e),this.root=t,N(e),ze(t);return}s.l===e?r?this.root=Ji(this.root,t,e,s):this.root=Hi(this.root,t,e,s):r?this.root=Wi(this.root,t,e,s):this.root=qi(this.root,t,e,s),N(s),N(e),ze(t),this.splay(t)}iterator(){let t=this.first();return()=>{const e=t;return t&&(t=I(t)),e}}ingest(t,e){if(t<1)return;const s=new Map;this.root=this._ingest(t,()=>{const r=e(),i=r.id,n=i.sid+"."+i.time,c=s.get(n);c&&(c.s=r,s.delete(n));const a=E(i,r.span);return s.set(a.sid+"."+a.time,r),r})}_ingest(t,e){const s=t>>1,r=t-s-1,i=s>0?this._ingest(s,e):void 0,n=e();i&&(n.l=i,i.p=n);const c=r>0?this._ingest(r,e):void 0;return c&&(n.r=c,c.p=n),N(n),this.insertId(n),n}toStringName(){return this.constructor.name}toString(t=""){const e=this.view();let s="";return de(e)?s+=` { ${We(e)||"∅"} }`:typeof e=="string"&&(s+=`{ ${e.length>32?JSON.stringify(e.substring(0,32))+" …":JSON.stringify(e)} }`),`${this.toStringName()} ${m(this.id)} ${s}`+C(t,[i=>this.root?this.printChunk(i,this.root):"∅"])}printChunk(t,e){return this.formatChunk(e)+ke(t,[e.l?s=>this.printChunk(s,e.l):null,e.r?s=>this.printChunk(s,e.r):null])}formatChunk(t){const e=m(t.id);let s=`${t.constructor.name} ${e}!${t.span} len:${t.len}`;if(t.del)s+=` [${t.span}]`;else if(de(t.data))s+=` { ${We(t.data)||"∅"} }`;else if(typeof t.data=="string"){const r=t.data.length>32?JSON.stringify(t.data.substring(0,32))+" …":JSON.stringify(t.data);s+=` { ${r} }`}return s}}class z{constructor(t,e,s){l(this,"id");l(this,"span");l(this,"del");l(this,"data");l(this,"len");l(this,"p");l(this,"l");l(this,"r");l(this,"p2");l(this,"l2");l(this,"r2");l(this,"s");this.id=t,this.span=e,this.len=s?e:0,this.del=!s,this.p=void 0,this.l=void 0,this.r=void 0,this.s=void 0,this.data=s}merge(t){this.data.push(...t),this.span=this.data.length}split(t){const e=this.span;if(this.span=t,!this.del){const r=this.data.splice(t);return new z(E(this.id,t),e-t,r)}return new z(E(this.id,t),e-t,void 0)}delete(){this.del=!0,this.data=void 0}clone(){return new z(this.id,this.span,this.data?[...this.data]:void 0)}}class $ extends Se{constructor(e,s){super(s);l(this,"doc");l(this,"_tick",0);l(this,"_view",[]);l(this,"api");this.doc=e}get(e){const s=this.findChunk(e);if(s)return s[0].data[s[1]]}getNode(e){const s=this.get(e);if(s)return this.doc.index.get(s)}getById(e){const s=this.findById(e);if(!s||s.del)return;const r=e.time-s.id.time;return s.data[r]}createChunk(e,s){return new z(e,s?s.length:0,s)}onChange(){}toStringName(){return this.name()}child(){}container(){return this}view(){const e=this.doc,s=e.clock.time+e.tick,r=this._view;if(this._tick===s)return r;const i=[],n=e.index;let c=!0;for(let h=this.first();h;h=this.next(h))if(!h.del)for(const d of h.data){const u=n.get(d);if(!u){c=!1;continue}const f=u.view();r[i.length]!==f&&(c=!1),i.push(f)}return r.length!==i.length&&(c=!1),c?r:(this._tick=s,this._view=i)}children(e){const s=this.doc.index;for(let r=this.first();r;r=this.next(r))if(!r.del)for(const i of r.data)e(s.get(i))}name(){return"arr"}printChunk(e,s){const r=this.pos(s);let i="";if(!s.del){const n=this.doc.index;i=C(e,s.data.map(c=>n.get(c)).filter(c=>!!c).map((c,a)=>h=>`[${r+a}]: ${c.toString(h+"    "+" ".repeat(String(a).length))}`))}return this.formatChunk(s)+i+ke(e,[s.l?n=>this.printChunk(n,s.l):null,s.r?n=>this.printChunk(n,s.r):null])}}class Y{constructor(t,e,s){l(this,"id");l(this,"span");l(this,"del");l(this,"data");l(this,"len");l(this,"p");l(this,"l");l(this,"r");l(this,"p2");l(this,"l2");l(this,"r2");l(this,"s");this.id=t,this.span=e,this.len=s?e:0,this.del=!s,this.p=void 0,this.l=void 0,this.r=void 0,this.s=void 0,this.data=s}merge(t){const e=this.data.length,s=new Uint8Array(e+t.length);s.set(this.data),s.set(t,e),this.data=s,this.span=s.length}split(t){if(!this.del){const s=this.data,r=s.subarray(t),i=new Y(E(this.id,t),this.span-t,r);return this.data=s.subarray(0,t),this.span=t,i}const e=new Y(E(this.id,t),this.span-t,void 0);return this.span=t,e}delete(){this.del=!0,this.data=void 0}clone(){return new Y(this.id,this.span,this.data)}}class D extends Se{constructor(){super(...arguments);l(this,"_view",null);l(this,"api")}view(){if(this._view)return this._view;const e=new Uint8Array(this.length());let s=0,r=this.first();for(;r;){if(!r.del){const i=r.data;e.set(i,s),s+=i.length}r=this.next(r)}return this._view=e}children(){}child(){}container(){}name(){return"bin"}createChunk(e,s){return new Y(e,s?s.length:0,s)}onChange(){this._view=null}toStringName(){return this.name()}}class G{constructor(t,e,s){l(this,"id");l(this,"span");l(this,"del");l(this,"data");l(this,"len");l(this,"p");l(this,"l");l(this,"r");l(this,"p2");l(this,"l2");l(this,"r2");l(this,"s");this.id=t,this.span=e,this.len=s?e:0,this.del=!s,this.p=void 0,this.l=void 0,this.r=void 0,this.p2=void 0,this.l2=void 0,this.r2=void 0,this.s=void 0,this.data=s}merge(t){this.data+=t,this.span=this.data.length}split(t){if(!this.del){const s=new G(E(this.id,t),this.span-t,this.data.slice(t));return this.data=this.data.slice(0,t),this.span=t,s}const e=new G(E(this.id,t),this.span-t,"");return this.span=t,e}delete(){this.del=!0,this.data=""}clone(){return new G(this.id,this.span,this.data)}}class U extends Se{constructor(){super(...arguments);l(this,"_view","");l(this,"api")}children(){}child(){}container(){}view(){if(this._view)return this._view;let e="";for(let s=this.first();s;s=le(s))e+=s.data;return this._view=e}name(){return"str"}createChunk(e,s){return new G(e,s?s.length:0,s||"")}onChange(){this._view=""}toStringName(){return this.name()}}var Ye;(function(o){class t extends B{constructor(d){super(u=>u.const(d));l(this,"raw");l(this,"type","con");this.raw=d}}o.con=t;class e extends B{constructor(d){super(u=>u.json(d));l(this,"raw");l(this,"type","str");this.raw=d}}o.str=e;class s extends B{constructor(d){super(u=>u.json(d));l(this,"raw");l(this,"type","bin");this.raw=d}}o.bin=s;class r extends B{constructor(d){super(u=>{const f=u.val(),p=d.build(u);return u.setVal(f,p),f});l(this,"value");l(this,"type","val");this.value=d}}o.val=r;class i extends B{constructor(d){super(u=>{const f=u.vec(),p=d.length;if(p){const x=[];for(let b=0;b<p;b++){const y=d[b].build(u);x.push([b,y])}u.insVec(f,x)}return f});l(this,"value");l(this,"type","vec");this.value=d}}o.vec=i;class n extends B{constructor(d,u){super(f=>{const p=f.obj(),x=[],b={...d,...u},w=Object.keys(b),y=w.length;if(y){for(let g=0;g<y;g++){const v=w[g],_=b[v].build(f);x.push([v,_])}f.insObj(p,x)}return p});l(this,"obj");l(this,"opt");l(this,"type","obj");this.obj=d,this.opt=u}optional(){return this}}o.obj=n;class c extends B{constructor(d){super(u=>{const f=u.arr(),p=d.length;if(p){const x=[];for(let b=0;b<p;b++)x.push(d[b].build(u));u.insArr(f,f,x)}return f});l(this,"arr");l(this,"type","arr");this.arr=d}}o.arr=c})(Ye||(Ye={}));var Wt={},pe=function(o,t){return pe=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,s){e.__proto__=s}||function(e,s){for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])},pe(o,t)};function Qs(o,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");pe(o,t);function e(){this.constructor=o}o.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}var Yt=function(){return Yt=Object.assign||function(t){for(var e,s=1,r=arguments.length;s<r;s++){e=arguments[s];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])}return t},Yt.apply(this,arguments)};function Zs(o,t){var e={};for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&t.indexOf(s)<0&&(e[s]=o[s]);if(o!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,s=Object.getOwnPropertySymbols(o);r<s.length;r++)t.indexOf(s[r])<0&&Object.prototype.propertyIsEnumerable.call(o,s[r])&&(e[s[r]]=o[s[r]]);return e}function tr(o,t,e,s){var r=arguments.length,i=r<3?t:s===null?s=Object.getOwnPropertyDescriptor(t,e):s,n;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(o,t,e,s);else for(var c=o.length-1;c>=0;c--)(n=o[c])&&(i=(r<3?n(i):r>3?n(t,e,i):n(t,e))||i);return r>3&&i&&Object.defineProperty(t,e,i),i}function er(o,t){return function(e,s){t(e,s,o)}}function rn(o,t,e,s,r,i){function n(y){if(y!==void 0&&typeof y!="function")throw new TypeError("Function expected");return y}for(var c=s.kind,a=c==="getter"?"get":c==="setter"?"set":"value",h=!t&&o?s.static?o:o.prototype:null,d=t||(h?Object.getOwnPropertyDescriptor(h,s.name):{}),u,f=!1,p=e.length-1;p>=0;p--){var x={};for(var b in s)x[b]=b==="access"?{}:s[b];for(var b in s.access)x.access[b]=s.access[b];x.addInitializer=function(y){if(f)throw new TypeError("Cannot add initializers after decoration has completed");i.push(n(y||null))};var w=(0,e[p])(c==="accessor"?{get:d.get,set:d.set}:d[a],x);if(c==="accessor"){if(w===void 0)continue;if(w===null||typeof w!="object")throw new TypeError("Object expected");(u=n(w.get))&&(d.get=u),(u=n(w.set))&&(d.set=u),(u=n(w.init))&&r.unshift(u)}else(u=n(w))&&(c==="field"?r.unshift(u):d[a]=u)}h&&Object.defineProperty(h,s.name,d),f=!0}function nn(o,t,e){for(var s=arguments.length>2,r=0;r<t.length;r++)e=s?t[r].call(o,e):t[r].call(o);return s?e:void 0}function on(o){return typeof o=="symbol"?o:"".concat(o)}function cn(o,t,e){return typeof t=="symbol"&&(t=t.description?"[".concat(t.description,"]"):""),Object.defineProperty(o,"name",{configurable:!0,value:e?"".concat(e," ",t):t})}function sr(o,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(o,t)}function rr(o,t,e,s){function r(i){return i instanceof e?i:new e(function(n){n(i)})}return new(e||(e=Promise))(function(i,n){function c(d){try{h(s.next(d))}catch(u){n(u)}}function a(d){try{h(s.throw(d))}catch(u){n(u)}}function h(d){d.done?i(d.value):r(d.value).then(c,a)}h((s=s.apply(o,t||[])).next())})}function ir(o,t){var e={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},s,r,i,n;return n={next:c(0),throw:c(1),return:c(2)},typeof Symbol=="function"&&(n[Symbol.iterator]=function(){return this}),n;function c(h){return function(d){return a([h,d])}}function a(h){if(s)throw new TypeError("Generator is already executing.");for(;n&&(n=0,h[0]&&(e=0)),e;)try{if(s=1,r&&(i=h[0]&2?r.return:h[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,h[1])).done)return i;switch(r=0,i&&(h=[h[0]&2,i.value]),h[0]){case 0:case 1:i=h;break;case 4:return e.label++,{value:h[1],done:!1};case 5:e.label++,r=h[1],h=[0];continue;case 7:h=e.ops.pop(),e.trys.pop();continue;default:if(i=e.trys,!(i=i.length>0&&i[i.length-1])&&(h[0]===6||h[0]===2)){e=0;continue}if(h[0]===3&&(!i||h[1]>i[0]&&h[1]<i[3])){e.label=h[1];break}if(h[0]===6&&e.label<i[1]){e.label=i[1],i=h;break}if(i&&e.label<i[2]){e.label=i[2],e.ops.push(h);break}i[2]&&e.ops.pop(),e.trys.pop();continue}h=t.call(o,e)}catch(d){h=[6,d],r=0}finally{s=i=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}}var Zt=Object.create?function(o,t,e,s){s===void 0&&(s=e);var r=Object.getOwnPropertyDescriptor(t,e);(!r||("get"in r?!t.__esModule:r.writable||r.configurable))&&(r={enumerable:!0,get:function(){return t[e]}}),Object.defineProperty(o,s,r)}:function(o,t,e,s){s===void 0&&(s=e),o[s]=t[e]};function nr(o,t){for(var e in o)e!=="default"&&!Object.prototype.hasOwnProperty.call(t,e)&&Zt(t,o,e)}function Gt(o){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&o[t],s=0;if(e)return e.call(o);if(o&&typeof o.length=="number")return{next:function(){return o&&s>=o.length&&(o=void 0),{value:o&&o[s++],done:!o}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function je(o,t){var e=typeof Symbol=="function"&&o[Symbol.iterator];if(!e)return o;var s=e.call(o),r,i=[],n;try{for(;(t===void 0||t-- >0)&&!(r=s.next()).done;)i.push(r.value)}catch(c){n={error:c}}finally{try{r&&!r.done&&(e=s.return)&&e.call(s)}finally{if(n)throw n.error}}return i}function or(){for(var o=[],t=0;t<arguments.length;t++)o=o.concat(je(arguments[t]));return o}function cr(){for(var o=0,t=0,e=arguments.length;t<e;t++)o+=arguments[t].length;for(var s=Array(o),r=0,t=0;t<e;t++)for(var i=arguments[t],n=0,c=i.length;n<c;n++,r++)s[r]=i[n];return s}function ar(o,t,e){if(e||arguments.length===2)for(var s=0,r=t.length,i;s<r;s++)(i||!(s in t))&&(i||(i=Array.prototype.slice.call(t,0,s)),i[s]=t[s]);return o.concat(i||Array.prototype.slice.call(t))}function rt(o){return this instanceof rt?(this.v=o,this):new rt(o)}function hr(o,t,e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s=e.apply(o,t||[]),r,i=[];return r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r;function n(f){s[f]&&(r[f]=function(p){return new Promise(function(x,b){i.push([f,p,x,b])>1||c(f,p)})})}function c(f,p){try{a(s[f](p))}catch(x){u(i[0][3],x)}}function a(f){f.value instanceof rt?Promise.resolve(f.value.v).then(h,d):u(i[0][2],f)}function h(f){c("next",f)}function d(f){c("throw",f)}function u(f,p){f(p),i.shift(),i.length&&c(i[0][0],i[0][1])}}function ur(o){var t,e;return t={},s("next"),s("throw",function(r){throw r}),s("return"),t[Symbol.iterator]=function(){return this},t;function s(r,i){t[r]=o[r]?function(n){return(e=!e)?{value:rt(o[r](n)),done:!1}:i?i(n):n}:i}}function dr(o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=o[Symbol.asyncIterator],e;return t?t.call(o):(o=typeof Gt=="function"?Gt(o):o[Symbol.iterator](),e={},s("next"),s("throw"),s("return"),e[Symbol.asyncIterator]=function(){return this},e);function s(i){e[i]=o[i]&&function(n){return new Promise(function(c,a){n=o[i](n),r(c,a,n.done,n.value)})}}function r(i,n,c,a){Promise.resolve(a).then(function(h){i({value:h,done:c})},n)}}function fr(o,t){return Object.defineProperty?Object.defineProperty(o,"raw",{value:t}):o.raw=t,o}var an=Object.create?function(o,t){Object.defineProperty(o,"default",{enumerable:!0,value:t})}:function(o,t){o.default=t};function lr(o){if(o&&o.__esModule)return o;var t={};if(o!=null)for(var e in o)e!=="default"&&Object.prototype.hasOwnProperty.call(o,e)&&Zt(t,o,e);return an(t,o),t}function pr(o){return o&&o.__esModule?o:{default:o}}function br(o,t,e,s){if(e==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?o!==t||!s:!t.has(o))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?s:e==="a"?s.call(o):s?s.value:t.get(o)}function wr(o,t,e,s,r){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?o!==t||!r:!t.has(o))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?r.call(o,e):r?r.value=e:t.set(o,e),e}function xr(o,t){if(t===null||typeof t!="object"&&typeof t!="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof o=="function"?t===o:o.has(t)}function yr(o,t,e){if(t!=null){if(typeof t!="object"&&typeof t!="function")throw new TypeError("Object expected.");var s;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");s=t[Symbol.asyncDispose]}if(s===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");s=t[Symbol.dispose]}if(typeof s!="function")throw new TypeError("Object not disposable.");o.stack.push({value:t,dispose:s,async:e})}else e&&o.stack.push({async:!0});return t}var hn=typeof SuppressedError=="function"?SuppressedError:function(o,t,e){var s=new Error(e);return s.name="SuppressedError",s.error=o,s.suppressed=t,s};function gr(o){function t(s){o.error=o.hasError?new hn(s,o.error,"An error was suppressed during disposal."):s,o.hasError=!0}function e(){for(;o.stack.length;){var s=o.stack.pop();try{var r=s.dispose&&s.dispose.call(s.value);if(s.async)return Promise.resolve(r).then(e,function(i){return t(i),e()})}catch(i){t(i)}}if(o.hasError)throw o.error}return e()}const un={__extends:Qs,__assign:Yt,__rest:Zs,__decorate:tr,__param:er,__metadata:sr,__awaiter:rr,__generator:ir,__createBinding:Zt,__exportStar:nr,__values:Gt,__read:je,__spread:or,__spreadArrays:cr,__spreadArray:ar,__await:rt,__asyncGenerator:hr,__asyncDelegator:ur,__asyncValues:dr,__makeTemplateObject:fr,__importStar:lr,__importDefault:pr,__classPrivateFieldGet:br,__classPrivateFieldSet:wr,__classPrivateFieldIn:xr,__addDisposableResource:yr,__disposeResources:gr},dn=Object.freeze(Object.defineProperty({__proto__:null,__addDisposableResource:yr,get __assign(){return Yt},__asyncDelegator:ur,__asyncGenerator:hr,__asyncValues:dr,__await:rt,__awaiter:rr,__classPrivateFieldGet:br,__classPrivateFieldIn:xr,__classPrivateFieldSet:wr,__createBinding:Zt,__decorate:tr,__disposeResources:gr,__esDecorate:rn,__exportStar:nr,__extends:Qs,__generator:ir,__importDefault:pr,__importStar:lr,__makeTemplateObject:fr,__metadata:sr,__param:er,__propKey:on,__read:je,__rest:Zs,__runInitializers:nn,__setFunctionName:cn,__spread:or,__spreadArray:ar,__spreadArrays:cr,__values:Gt,default:un},Symbol.toStringTag,{value:"Module"})),T=ei(dn);var re={},Ge;function fn(){return Ge||(Ge=1,Object.defineProperty(re,"__esModule",{value:!0})),re}var ie={},ne={},Xe;function ln(){return Xe||(Xe=1,Object.defineProperty(ne,"__esModule",{value:!0})),ne}var oe={},Qe;function pn(){return Qe||(Qe=1,function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.ServerClockVector=o.ClockVector=o.LogicalClock=o.interval=o.toDisplayString=o.containsId=o.contains=o.compare=o.equal=o.tick=o.tss=o.ts=o.Timespan=o.Timestamp=void 0;class t{constructor(w,y){this.sid=w,this.time=y}}o.Timestamp=t;class e{constructor(w,y,g){this.sid=w,this.time=y,this.span=g}}o.Timespan=e;const s=(b,w)=>new t(b,w);o.ts=s;const r=(b,w,y)=>new e(b,w,y);o.tss=r;const i=(b,w)=>(0,o.ts)(b.sid,b.time+w);o.tick=i;const n=(b,w)=>b.time===w.time&&b.sid===w.sid;o.equal=n;const c=(b,w)=>{const y=b.time,g=w.time;if(y>g)return 1;if(y<g)return-1;const v=b.sid,_=w.sid;return v>_?1:v<_?-1:0};o.compare=c;const a=(b,w,y,g)=>{if(b.sid!==y.sid)return!1;const v=b.time,_=y.time;return!(v>_||v+w<_+g)};o.contains=a;const h=(b,w,y)=>{if(b.sid!==y.sid)return!1;const g=b.time,v=y.time;return!(g>v||g+w<v+1)};o.containsId=h;const d=b=>{if(b.sid===1)return"."+b.time;let w=""+b.sid;return w.length>4&&(w=".."+w.slice(w.length-4)),w+"."+b.time};o.toDisplayString=d;const u=(b,w,y)=>new e(b.sid,b.time+w,y);o.interval=u;class f extends t{tick(w){const y=new t(this.sid,this.time);return this.time+=w,y}}o.LogicalClock=f;class p extends f{constructor(){super(...arguments),this.peers=new Map}observe(w,y){const g=w.time+y-1,v=w.sid;if(v!==this.sid){const _=this.peers.get(w.sid);_?g>_.time&&(_.time=g):this.peers.set(w.sid,(0,o.ts)(v,g))}g>=this.time&&(this.time=g+1)}clone(){return this.fork(this.sid)}fork(w){const y=new p(w,this.time);return w!==this.sid&&y.observe((0,o.tick)(this,-1),1),this.peers.forEach(g=>{y.observe(g,1)}),y}toString(w=""){const y=this.peers.size;let g=1,v="";return this.peers.forEach(_=>{v+=`
${w}${g===y?"└─":"├─"} ${_.sid}.${_.time}`,g++}),`clock ${this.sid}.${this.time}${v}`}}o.ClockVector=p;class x extends f{constructor(){super(...arguments),this.peers=new Map}observe(w,y){if(w.sid!==1)throw new Error("INVALID_SERVER_SESSION");if(this.time<w.time)throw new Error("TIME_TRAVEL");const g=w.time+y;g>this.time&&(this.time=g)}clone(){return this.fork()}fork(){return new x(1,this.time)}toString(){return`clock ${this.sid}.${this.time}`}}o.ServerClockVector=x}(oe)),oe}var Ze;function Z(){return Ze||(Ze=1,function(o){Object.defineProperty(o,"__esModule",{value:!0});const t=T;t.__exportStar(ln(),o),t.__exportStar(pn(),o)}(ie)),ie}var k={},ts;function te(){if(ts)return k;ts=1,Object.defineProperty(k,"__esModule",{value:!0}),k.NopOp=k.DelOp=k.InsArrOp=k.InsBinOp=k.InsStrOp=k.InsVecOp=k.InsObjOp=k.InsValOp=k.NewArrOp=k.NewBinOp=k.NewStrOp=k.NewVecOp=k.NewObjOp=k.NewValOp=k.NewConOp=void 0;const o=Z();class t{constructor(y,g){this.id=y,this.val=g}span(){return 1}name(){return"new_con"}toString(y=""){const g=this.val,v=g instanceof o.Timestamp?`{ ${(0,o.toDisplayString)(g)} }`:g instanceof Uint8Array?g.length<13?`Uint8Array { ${(""+g).replaceAll(",",", ")} }`:`Uint8Array(${g.length})`:`{ ${JSON.stringify(g)} }`;return`${this.name()} ${(0,o.toDisplayString)(this.id)} ${v}`}}k.NewConOp=t;class e{constructor(y){this.id=y}span(){return 1}name(){return"new_val"}toString(){return`${this.name()} ${(0,o.toDisplayString)(this.id)}`}}k.NewValOp=e;class s{constructor(y){this.id=y}span(){return 1}name(){return"new_obj"}toString(){return`${this.name()} ${(0,o.toDisplayString)(this.id)}`}}k.NewObjOp=s;class r{constructor(y){this.id=y}span(){return 1}name(){return"new_vec"}toString(){return`${this.name()} ${(0,o.toDisplayString)(this.id)}`}}k.NewVecOp=r;class i{constructor(y){this.id=y}span(){return 1}name(){return"new_str"}toString(){return`${this.name()} ${(0,o.toDisplayString)(this.id)}`}}k.NewStrOp=i;class n{constructor(y){this.id=y}span(){return 1}name(){return"new_bin"}toString(y=""){return`${this.name()} ${(0,o.toDisplayString)(this.id)}`}}k.NewBinOp=n;class c{constructor(y){this.id=y}span(){return 1}name(){return"new_arr"}toString(){return`${this.name()} ${(0,o.toDisplayString)(this.id)}`}}k.NewArrOp=c;class a{constructor(y,g,v){this.id=y,this.obj=g,this.val=v}span(){return 1}name(){return"ins_val"}toString(y=""){return`${this.name()} ${(0,o.toDisplayString)(this.id)}!${this.span()}, obj = ${(0,o.toDisplayString)(this.obj)}, val = ${(0,o.toDisplayString)(this.val)}`}}k.InsValOp=a;class h{constructor(y,g,v){this.id=y,this.obj=g,this.data=v}span(){return 1}name(){return"ins_obj"}toString(y=""){let g=`${this.name()} ${(0,o.toDisplayString)(this.id)}!${this.span()}, obj = ${(0,o.toDisplayString)(this.obj)}`;for(let v=0;v<this.data.length;v++){const _=v===this.data.length-1;g+=`
${y}  ${_?"└─":"├─"} ${JSON.stringify(this.data[v][0])}: ${(0,o.toDisplayString)(this.data[v][1])}`}return g}}k.InsObjOp=h;class d{constructor(y,g,v){this.id=y,this.obj=g,this.data=v}span(){return 1}name(){return"ins_vec"}toString(y=""){let g=`${this.name()} ${(0,o.toDisplayString)(this.id)}!${this.span()}, obj = ${(0,o.toDisplayString)(this.obj)}`;for(let v=0;v<this.data.length;v++){const _=v===this.data.length-1;g+=`
${y}  ${_?"└─":"├─"} ${JSON.stringify(this.data[v][0])}: ${(0,o.toDisplayString)(this.data[v][1])}`}return g}}k.InsVecOp=d;class u{constructor(y,g,v,_){this.id=y,this.obj=g,this.ref=v,this.data=_}span(){return this.data.length}name(){return"ins_str"}toString(){return`${this.name()} ${(0,o.toDisplayString)(this.id)}!${this.span()}, obj = ${(0,o.toDisplayString)(this.obj)} { ${(0,o.toDisplayString)(this.ref)} ← ${JSON.stringify(this.data)} }`}}k.InsStrOp=u;class f{constructor(y,g,v,_){this.id=y,this.obj=g,this.ref=v,this.data=_}span(){return this.data.length}name(){return"ins_bin"}toString(y=""){const g=(0,o.toDisplayString)(this.ref);return`${this.name()} ${(0,o.toDisplayString)(this.id)}!${this.span()}, obj = ${(0,o.toDisplayString)(this.obj)} { ${g} ← ${this.data} }`}}k.InsBinOp=f;class p{constructor(y,g,v,_){this.id=y,this.obj=g,this.ref=v,this.data=_}span(){return this.data.length}name(){return"ins_arr"}toString(){return`${this.name()} ${(0,o.toDisplayString)(this.id)}!${this.span()}, obj = ${(0,o.toDisplayString)(this.obj)} { ${(0,o.toDisplayString)(this.ref)} ← ${this.data.map(o.toDisplayString).join(", ")} }`}}k.InsArrOp=p;class x{constructor(y,g,v){this.id=y,this.obj=g,this.what=v}span(){return 1}name(){return"del"}toString(){const y=this.what.map(g=>(0,o.toDisplayString)(g)+"!"+g.span).join(", ");return`${this.name()} ${(0,o.toDisplayString)(this.id)}, obj = ${(0,o.toDisplayString)(this.obj)} { ${y} }`}}k.DelOp=x;class b{constructor(y,g){this.id=y,this.len=g}span(){return this.len}name(){return"nop"}toString(){return`${this.name()} ${(0,o.toDisplayString)(this.id)}!${this.len}`}}return k.NopOp=b,k}var ot={},ce={},ct={},at={},ht={},ut={},es;function bn(){if(es)return ut;es=1,Object.defineProperty(ut,"__esModule",{value:!0}),ut.Slice=void 0;let o=class{constructor(e,s,r,i){this.uint8=e,this.view=s,this.start=r,this.end=i}subarray(){return this.uint8.subarray(this.start,this.end)}};return ut.Slice=o,ut}var ss;function vr(){if(ss)return ht;ss=1,Object.defineProperty(ht,"__esModule",{value:!0}),ht.Writer=void 0;const o=bn(),t=new Uint8Array([]),e=new DataView(t.buffer),s=typeof Buffer=="function",r=s?Buffer.prototype.utf8Write:null,i=s?Buffer.from:null,n=typeof TextEncoder<"u"?new TextEncoder:null;let c=class{constructor(h=64*1024){this.allocSize=h,this.view=e,this.x0=0,this.x=0,this.uint8=new Uint8Array(h),this.size=h,this.view=new DataView(this.uint8.buffer)}grow(h){const d=this.x0,u=this.x,f=this.uint8,p=new Uint8Array(h),x=new DataView(p.buffer),b=f.subarray(d,u);p.set(b,0),this.x=u-d,this.x0=0,this.uint8=p,this.size=h,this.view=x}ensureCapacity(h){const d=this.size,u=d-this.x;if(u<h){const f=d-this.x0,p=h-u,x=f+p;this.grow(x<=this.allocSize?this.allocSize:x*2)}}move(h){this.ensureCapacity(h),this.x+=h}reset(){this.x0=this.x}newBuffer(h){const d=this.uint8=new Uint8Array(h);this.size=h,this.view=new DataView(d.buffer),this.x=this.x0=0}flush(){const h=this.uint8.subarray(this.x0,this.x);return this.x0=this.x,h}flushSlice(){const h=new o.Slice(this.uint8,this.view,this.x0,this.x);return this.x0=this.x,h}u8(h){this.ensureCapacity(1),this.uint8[this.x++]=h}u16(h){this.ensureCapacity(2),this.view.setUint16(this.x,h),this.x+=2}u32(h){this.ensureCapacity(4),this.view.setUint32(this.x,h),this.x+=4}i32(h){this.ensureCapacity(4),this.view.setInt32(this.x,h),this.x+=4}u64(h){this.ensureCapacity(8),this.view.setBigUint64(this.x,BigInt(h)),this.x+=8}f64(h){this.ensureCapacity(8),this.view.setFloat64(this.x,h),this.x+=8}u8u16(h,d){this.ensureCapacity(3);let u=this.x;this.uint8[u++]=h,this.uint8[u++]=d>>>8,this.uint8[u++]=d&255,this.x=u}u8u32(h,d){this.ensureCapacity(5);let u=this.x;this.uint8[u++]=h,this.view.setUint32(u,d),this.x=u+4}u8u64(h,d){this.ensureCapacity(9);let u=this.x;this.uint8[u++]=h,this.view.setBigUint64(u,BigInt(d)),this.x=u+8}u8f32(h,d){this.ensureCapacity(5);let u=this.x;this.uint8[u++]=h,this.view.setFloat32(u,d),this.x=u+4}u8f64(h,d){this.ensureCapacity(9);let u=this.x;this.uint8[u++]=h,this.view.setFloat64(u,d),this.x=u+8}buf(h,d){this.ensureCapacity(d);const u=this.x;this.uint8.set(h,u),this.x=u+d}utf8(h){const d=h.length*4;if(d<168)return this.utf8Native(h);if(r){const u=r.call(this.uint8,h,this.x,d);return this.x+=u,u}else if(i){const u=this.uint8,f=u.byteOffset+this.x,x=i(u.buffer).subarray(f,f+d).write(h,0,d,"utf8");return this.x+=x,x}else if(d>1024&&n){const u=n.encodeInto(h,this.uint8.subarray(this.x,this.x+d)).written;return this.x+=u,u}return this.utf8Native(h)}utf8Native(h){const d=h.length,u=this.uint8;let f=this.x,p=0;for(;p<d;){let b=h.charCodeAt(p++);if(b&4294967168)if(!(b&4294965248))u[f++]=b>>6&31|192;else{if(b>=55296&&b<=56319&&p<d){const w=h.charCodeAt(p);(w&64512)===56320&&(p++,b=((b&1023)<<10)+(w&1023)+65536)}b&4294901760?(u[f++]=b>>18&7|240,u[f++]=b>>12&63|128,u[f++]=b>>6&63|128):(u[f++]=b>>12&15|224,u[f++]=b>>6&63|128)}else{u[f++]=b;continue}u[f++]=b&63|128}const x=f-this.x;return this.x=f,x}ascii(h){const d=h.length;this.ensureCapacity(d);const u=this.uint8;let f=this.x,p=0;for(;p<d;)u[f++]=h.charCodeAt(p++);this.x=f}};return ht.Writer=c,ht}var rs;function mr(){if(rs)return at;rs=1,Object.defineProperty(at,"__esModule",{value:!0}),at.CrdtWriter=void 0;const o=vr();let t=class extends o.Writer{id(s,r){s<=7&&r<=15?this.u8(s<<4|r):(this.b1vu56(1,s),this.vu57(r))}vu57(s){if(s<=127)this.u8(s);else if(s<=16383){this.ensureCapacity(2);const r=this.uint8;r[this.x++]=128|s&127,r[this.x++]=s>>>7}else if(s<=2097151){this.ensureCapacity(3);const r=this.uint8;r[this.x++]=128|s&127,r[this.x++]=128|s>>>7&127,r[this.x++]=s>>>14}else if(s<=268435455){this.ensureCapacity(4);const r=this.uint8;r[this.x++]=128|s&127,r[this.x++]=128|s>>>7&127,r[this.x++]=128|s>>>14&127,r[this.x++]=s>>>21}else{let r=s|0;r<0&&(r+=4294967296);const i=(s-r)/4294967296;if(s<=34359738367){this.ensureCapacity(5);const n=this.uint8;n[this.x++]=128|s&127,n[this.x++]=128|s>>>7&127,n[this.x++]=128|s>>>14&127,n[this.x++]=128|s>>>21&127,n[this.x++]=i<<4|s>>>28}else if(s<=4398046511103){this.ensureCapacity(6);const n=this.uint8;n[this.x++]=128|s&127,n[this.x++]=128|s>>>7&127,n[this.x++]=128|s>>>14&127,n[this.x++]=128|s>>>21&127,n[this.x++]=128|(i&7)<<4|s>>>28,n[this.x++]=i>>>3}else if(s<=562949953421311){this.ensureCapacity(7);const n=this.uint8;n[this.x++]=128|s&127,n[this.x++]=128|s>>>7&127,n[this.x++]=128|s>>>14&127,n[this.x++]=128|s>>>21&127,n[this.x++]=128|(i&7)<<4|s>>>28,n[this.x++]=128|(i&1016)>>>3,n[this.x++]=i>>>10}else{this.ensureCapacity(8);const n=this.uint8;n[this.x++]=128|s&127,n[this.x++]=128|s>>>7&127,n[this.x++]=128|s>>>14&127,n[this.x++]=128|s>>>21&127,n[this.x++]=128|(i&7)<<4|s>>>28,n[this.x++]=128|(i&1016)>>>3,n[this.x++]=128|(i&130048)>>>10,n[this.x++]=i>>>17}}}b1vu56(s,r){if(r<=63)this.u8(s<<7|r);else{const i=s<<7|64;if(r<=8191){this.ensureCapacity(2);const n=this.uint8;n[this.x++]=i|r&63,n[this.x++]=r>>>6}else if(r<=1048575){this.ensureCapacity(3);const n=this.uint8;n[this.x++]=i|r&63,n[this.x++]=128|r>>>6&127,n[this.x++]=r>>>13}else if(r<=134217727){this.ensureCapacity(4);const n=this.uint8;n[this.x++]=i|r&63,n[this.x++]=128|r>>>6&127,n[this.x++]=128|r>>>13&127,n[this.x++]=r>>>20}else{let n=r|0;n<0&&(n+=4294967296);const c=(r-n)/4294967296;if(r<=17179869183){this.ensureCapacity(5);const a=this.uint8;a[this.x++]=i|r&63,a[this.x++]=128|r>>>6&127,a[this.x++]=128|r>>>13&127,a[this.x++]=128|r>>>20&127,a[this.x++]=c<<5|r>>>27}else if(r<=2199023255551){this.ensureCapacity(6);const a=this.uint8;a[this.x++]=i|r&63,a[this.x++]=128|r>>>6&127,a[this.x++]=128|r>>>13&127,a[this.x++]=128|r>>>20&127,a[this.x++]=128|(c&3)<<5|r>>>27,a[this.x++]=c>>>2}else if(r<=0xffffffffffff){this.ensureCapacity(7);const a=this.uint8;a[this.x++]=i|r&63,a[this.x++]=128|r>>>6&127,a[this.x++]=128|r>>>13&127,a[this.x++]=128|r>>>20&127,a[this.x++]=128|(c&3)<<5|r>>>27,a[this.x++]=128|(c&508)>>>2,a[this.x++]=c>>>9}else{this.ensureCapacity(8);const a=this.uint8;a[this.x++]=i|r&63,a[this.x++]=128|r>>>6&127,a[this.x++]=128|r>>>13&127,a[this.x++]=128|r>>>20&127,a[this.x++]=128|(c&3)<<5|r>>>27,a[this.x++]=128|(c&508)>>>2,a[this.x++]=128|(c&65024)>>>9,a[this.x++]=c>>>16}}}}};return at.CrdtWriter=t,at}var dt={},ft={},is;function wn(){if(is)return ft;is=1,Object.defineProperty(ft,"__esModule",{value:!0}),ft.isFloat32=void 0;const o=new DataView(new ArrayBuffer(4)),t=e=>(o.setFloat32(0,e),e===o.getFloat32(0));return ft.isFloat32=t,ft}var lt={},ns;function kr(){if(ns)return lt;ns=1,Object.defineProperty(lt,"__esModule",{value:!0}),lt.JsonPackExtension=void 0;let o=class{constructor(e,s){this.tag=e,this.val=s}};return lt.JsonPackExtension=o,lt}var pt={},os;function xn(){if(os)return pt;os=1,Object.defineProperty(pt,"__esModule",{value:!0}),pt.CborEncoderFast=void 0;const o=vr(),t=Number.isSafeInteger;let e=class{constructor(r=new o.Writer){this.writer=r}encode(r){return this.writeAny(r),this.writer.flush()}encodeToSlice(r){return this.writeAny(r),this.writer.flushSlice()}writeAny(r){switch(typeof r){case"number":return this.writeNumber(r);case"string":return this.writeStr(r);case"boolean":return this.writer.u8(244+ +r);case"object":{if(!r)return this.writer.u8(246);switch(r.constructor){case Array:return this.writeArr(r);default:return this.writeObj(r)}}}}writeCbor(){this.writer.u8u16(217,55799)}writeEnd(){this.writer.u8(255)}writeNull(){this.writer.u8(246)}writeBoolean(r){r?this.writer.u8(245):this.writer.u8(244)}writeNumber(r){t(r)?this.writeInteger(r):typeof r=="bigint"?this.writeBigInt(r):this.writeFloat(r)}writeBigInt(r){r>=0?this.writeBigUint(r):this.writeBigSint(r)}writeBigUint(r){if(r<=Number.MAX_SAFE_INTEGER)return this.writeUInteger(Number(r));this.writer.u8u64(27,r)}writeBigSint(r){if(r>=Number.MIN_SAFE_INTEGER)return this.encodeNint(Number(r));const i=-BigInt(1)-r;this.writer.u8u64(59,i)}writeInteger(r){r>=0?this.writeUInteger(r):this.encodeNint(r)}writeUInteger(r){const i=this.writer;i.ensureCapacity(9);const n=i.uint8;let c=i.x;r<=23?n[c++]=0+r:r<=255?(n[c++]=24,n[c++]=r):r<=65535?(n[c++]=25,i.view.setUint16(c,r),c+=2):r<=4294967295?(n[c++]=26,i.view.setUint32(c,r),c+=4):(n[c++]=27,i.view.setBigUint64(c,BigInt(r)),c+=8),i.x=c}encodeNumber(r){this.writeNumber(r)}encodeInteger(r){this.writeInteger(r)}encodeUint(r){this.writeUInteger(r)}encodeNint(r){const i=-1-r,n=this.writer;n.ensureCapacity(9);const c=n.uint8;let a=n.x;i<24?c[a++]=32+i:i<=255?(c[a++]=56,c[a++]=i):i<=65535?(c[a++]=57,n.view.setUint16(a,i),a+=2):i<=4294967295?(c[a++]=58,n.view.setUint32(a,i),a+=4):(c[a++]=59,n.view.setBigUint64(a,BigInt(i)),a+=8),n.x=a}writeFloat(r){this.writer.u8f64(251,r)}writeBin(r){const i=r.length;this.writeBinHdr(i),this.writer.buf(r,i)}writeBinHdr(r){const i=this.writer;r<=23?i.u8(64+r):r<=255?i.u16(22528+r):r<=65535?i.u8u16(89,r):r<=4294967295?i.u8u32(90,r):i.u8u64(91,r)}writeStr(r){const i=this.writer,c=r.length*4;i.ensureCapacity(5+c);const a=i.uint8;let h=i.x;c<=23?i.x++:c<=255?(a[i.x++]=120,h=i.x,i.x++):c<=65535?(a[i.x++]=121,h=i.x,i.x+=2):(a[i.x++]=122,h=i.x,i.x+=4);const d=i.utf8(r);c<=23?a[h]=96+d:c<=255?a[h]=d:c<=65535?i.view.setUint16(h,d):i.view.setUint32(h,d)}writeStrHdr(r){const i=this.writer;r<=23?i.u8(96+r):r<=255?i.u16(30720+r):r<=65535?i.u8u16(121,r):i.u8u32(122,r)}writeAsciiStr(r){this.writeStrHdr(r.length),this.writer.ascii(r)}writeArr(r){const i=r.length;this.writeArrHdr(i);for(let n=0;n<i;n++)this.writeAny(r[n])}writeArrHdr(r){const i=this.writer;r<=23?i.u8(128+r):r<=255?i.u16(38912+r):r<=65535?i.u8u16(153,r):r<=4294967295?i.u8u32(154,r):i.u8u64(155,r)}writeObj(r){const i=Object.keys(r),n=i.length;this.writeObjHdr(n);for(let c=0;c<n;c++){const a=i[c];this.writeStr(a),this.writeAny(r[a])}}writeObjHdr(r){const i=this.writer;r<=23?i.u8(160+r):r<=255?i.u16(47104+r):r<=65535?i.u8u16(185,r):r<=4294967295?i.u8u32(186,r):i.u8u64(187,r)}writeMapHdr(r){this.writeObjHdr(r)}writeStartMap(){this.writer.u8(191)}writeTag(r,i){this.writeTagHdr(r),this.writeAny(i)}writeTagHdr(r){const i=this.writer;r<=23?i.u8(192+r):r<=255?i.u16(55296+r):r<=65535?i.u8u16(217,r):r<=4294967295?i.u8u32(218,r):i.u8u64(219,r)}writeTkn(r){const i=this.writer;r<=23?i.u8(224+r):r<=255&&i.u16(63488+r)}writeStartStr(){this.writer.u8(127)}writeStrChunk(r){throw new Error("Not implemented")}writeEndStr(){throw new Error("Not implemented")}writeStartBin(){this.writer.u8(95)}writeBinChunk(r){throw new Error("Not implemented")}writeEndBin(){throw new Error("Not implemented")}writeStartArr(){this.writer.u8(159)}writeArrChunk(r){throw new Error("Not implemented")}writeEndArr(){this.writer.u8(255)}writeStartObj(){this.writer.u8(191)}writeObjChunk(r,i){throw new Error("Not implemented")}writeEndObj(){this.writer.u8(255)}};return pt.CborEncoderFast=e,pt}var cs;function yn(){if(cs)return dt;cs=1,Object.defineProperty(dt,"__esModule",{value:!0}),dt.CborEncoder=void 0;const o=wn(),t=kr(),e=xn();let s=class extends e.CborEncoderFast{writeUnknown(i){this.writeNull()}writeAny(i){switch(typeof i){case"number":return this.writeNumber(i);case"string":return this.writeStr(i);case"boolean":return this.writer.u8(244+ +i);case"object":{if(!i)return this.writer.u8(246);switch(i.constructor){case Object:return this.writeObj(i);case Array:return this.writeArr(i);case Uint8Array:return this.writeBin(i);case Map:return this.writeMap(i);case t.JsonPackExtension:return this.writeTag(i.tag,i.val);default:return this.writeUnknown(i)}}case"undefined":return this.writeUndef();case"bigint":return this.writeBigInt(i);default:return this.writeUnknown(i)}}writeFloat(i){(0,o.isFloat32)(i)?this.writer.u8f32(250,i):this.writer.u8f64(251,i)}writeMap(i){this.writeMapHdr(i.size),i.forEach((n,c)=>{this.writeAny(c),this.writeAny(n)})}writeUndef(){this.writer.u8(247)}};return dt.CborEncoder=s,dt}var as;function _r(){if(as)return ct;as=1,Object.defineProperty(ct,"__esModule",{value:!0}),ct.Encoder=void 0;const t=T.__importStar(te()),e=mr(),s=Z(),r=yn();let i=class extends r.CborEncoder{constructor(c=new e.CrdtWriter){super(c),this.writer=c,this.patchSid=0}encode(c){this.writer.reset();const a=c.getId(),h=this.patchSid=a.sid,d=this.writer;d.vu57(h),d.vu57(a.time);const u=c.meta;return u===void 0?this.writeUndef():this.writeArr([u]),this.encodeOperations(c),d.flush()}encodeOperations(c){const a=c.ops,h=a.length;this.writer.vu57(h);for(let d=0;d<h;d++)this.encodeOperation(a[d])}encodeId(c){const a=c.sid,h=c.time,d=this.writer;a===this.patchSid?d.b1vu56(0,h):(d.b1vu56(1,h),d.vu57(a))}encodeTss(c){this.encodeId(c),this.writer.vu57(c.span)}writeInsStr(c,a,h,d){const u=this.writer;return c<=7?u.u8(96+c):(u.u8(96),u.vu57(c)),this.encodeId(a),this.encodeId(h),u.utf8(d)}encodeOperation(c){const a=this.writer;switch(c.constructor){case t.NewConOp:{const u=c.val;u instanceof s.Timestamp?(a.u8(1),this.encodeId(u)):(a.u8(0),this.writeAny(u));break}case t.NewValOp:{a.u8(8);break}case t.NewObjOp:{a.u8(16);break}case t.NewVecOp:{a.u8(24);break}case t.NewStrOp:{a.u8(32);break}case t.NewBinOp:{a.u8(40);break}case t.NewArrOp:{a.u8(48);break}case t.InsValOp:{const d=c;a.u8(72),this.encodeId(d.obj),this.encodeId(d.val);break}case t.InsObjOp:{const d=c,u=d.data,f=u.length;f<=7?a.u8(80+f):(a.u8(80),a.vu57(f)),this.encodeId(d.obj);for(let p=0;p<f;p++){const x=u[p];this.writeStr(x[0]),this.encodeId(x[1])}break}case t.InsVecOp:{const d=c,u=d.data,f=u.length;f<=7?a.u8(88+f):(a.u8(88),a.vu57(f)),this.encodeId(d.obj);for(let p=0;p<f;p++){const x=u[p];a.u8(x[0]),this.encodeId(x[1])}break}case t.InsStrOp:{const d=c,u=d.obj,f=d.ref,p=d.data,x=p.length;a.ensureCapacity(24+x*4);const b=a.x,w=this.writeInsStr(x,u,f,p);x!==w&&(a.x=b,this.writeInsStr(w,u,f,p));break}case t.InsBinOp:{const d=c,u=d.data,f=u.length;f<=7?a.u8(104+f):(a.u8(104),a.vu57(f)),this.encodeId(d.obj),this.encodeId(d.ref),a.buf(u,f);break}case t.InsArrOp:{const d=c,u=d.data,f=u.length;f<=7?a.u8(112+f):(a.u8(112),a.vu57(f)),this.encodeId(d.obj),this.encodeId(d.ref);for(let p=0;p<f;p++)this.encodeId(u[p]);break}case t.DelOp:{const d=c,u=d.what,f=u.length;f<=7?a.u8(128+f):(a.u8(128),a.vu57(f)),this.encodeId(d.obj);for(let p=0;p<f;p++)this.encodeTss(u[p]);break}case t.NopOp:{const u=c.len;u<=7?a.u8(136+u):(a.u8(136),a.vu57(u));break}default:throw new Error("UNKNOWN_OP")}}};return ct.Encoder=i,ct}var bt={},wt={},xt={},yt={},Ft={},F={},hs;function gn(){if(hs)return F;hs=1,Object.defineProperty(F,"__esModule",{value:!0}),F.decodeAsciiMax15=F.decodeAscii=void 0;const o=String.fromCharCode,t=(s,r,i)=>{const n=[];for(let c=0;c<i;c++){const a=s[r++];if(a&128)return;n.push(a)}return o.apply(String,n)};F.decodeAscii=t;const e=(s,r,i)=>{if(i<4)if(i<2){if(i===0)return"";{const n=s[r++];if((n&128)>1){r-=1;return}return o(n)}}else{const n=s[r++],c=s[r++];if((n&128)>0||(c&128)>0){r-=2;return}if(i<3)return o(n,c);const a=s[r++];if((a&128)>0){r-=3;return}return o(n,c,a)}else{const n=s[r++],c=s[r++],a=s[r++],h=s[r++];if((n&128)>0||(c&128)>0||(a&128)>0||(h&128)>0){r-=4;return}if(i<6){if(i===4)return o(n,c,a,h);{const d=s[r++];if((d&128)>0){r-=5;return}return o(n,c,a,h,d)}}else if(i<8){const d=s[r++],u=s[r++];if((d&128)>0||(u&128)>0){r-=6;return}if(i<7)return o(n,c,a,h,d,u);const f=s[r++];if((f&128)>0){r-=7;return}return o(n,c,a,h,d,u,f)}else{const d=s[r++],u=s[r++],f=s[r++],p=s[r++];if((d&128)>0||(u&128)>0||(f&128)>0||(p&128)>0){r-=8;return}if(i<10){if(i===8)return o(n,c,a,h,d,u,f,p);{const x=s[r++];if((x&128)>0){r-=9;return}return o(n,c,a,h,d,u,f,p,x)}}else if(i<12){const x=s[r++],b=s[r++];if((x&128)>0||(b&128)>0){r-=10;return}if(i<11)return o(n,c,a,h,d,u,f,p,x,b);const w=s[r++];if((w&128)>0){r-=11;return}return o(n,c,a,h,d,u,f,p,x,b,w)}else{const x=s[r++],b=s[r++],w=s[r++],y=s[r++];if((x&128)>0||(b&128)>0||(w&128)>0||(y&128)>0){r-=12;return}if(i<14){if(i===12)return o(n,c,a,h,d,u,f,p,x,b,w,y);{const g=s[r++];if((g&128)>0){r-=13;return}return o(n,c,a,h,d,u,f,p,x,b,w,y,g)}}else{const g=s[r++],v=s[r++];if((g&128)>0||(v&128)>0){r-=14;return}if(i<15)return o(n,c,a,h,d,u,f,p,x,b,w,y,g,v);const _=s[r++];if((_&128)>0){r-=15;return}return o(n,c,a,h,d,u,f,p,x,b,w,y,g,v,_)}}}}};return F.decodeAsciiMax15=e,F}var qt={},us;function vn(){if(us)return qt;us=1,Object.defineProperty(qt,"__esModule",{value:!0});const o=String.fromCharCode;return qt.default=(t,e,s)=>{let r=e;const i=r+s,n=[];for(;r<i;){let c=t[r++];if(c&128){const a=t[r++]&63;if((c&224)===192)c=(c&31)<<6|a;else{const h=t[r++]&63;if((c&240)===224)c=(c&31)<<12|a<<6|h;else if((c&248)===240){const d=t[r++]&63;let u=(c&7)<<18|a<<12|h<<6|d;if(u>65535){u-=65536;const f=u>>>10&1023|55296;c=56320|u&1023,n.push(f)}else c=u}}}n.push(c)}return o.apply(String,n)},qt}var ds;function mn(){if(ds)return Ft;ds=1,Object.defineProperty(Ft,"__esModule",{value:!0});const o=T,t=gn(),e=o.__importDefault(vn()),s=typeof Buffer<"u",r=s?Buffer.prototype.utf8Slice:null,i=s?Buffer.from:null,n=(d,u,f)=>(0,t.decodeAsciiMax15)(d,u,f)??(0,e.default)(d,u,f),c=(d,u,f)=>(0,t.decodeAscii)(d,u,f)??(0,e.default)(d,u,f),a=r?(d,u,f)=>r.call(d,u,u+f):i?(d,u,f)=>i(d).subarray(u,u+f).toString("utf8"):e.default,h=(d,u,f)=>f<16?n(d,u,f):f<32?c(d,u,f):a(d,u,f);return Ft.default=h,Ft}var fs;function kn(){if(fs)return yt;fs=1,Object.defineProperty(yt,"__esModule",{value:!0}),yt.decodeUtf8=void 0;const t=T.__importDefault(mn());return yt.decodeUtf8=t.default,yt}var ls;function Or(){if(ls)return xt;ls=1,Object.defineProperty(xt,"__esModule",{value:!0}),xt.Reader=void 0;const o=kn();let t=class{constructor(){this.uint8=new Uint8Array([]),this.view=new DataView(this.uint8.buffer),this.x=0}reset(s){this.x=0,this.uint8=s,this.view=new DataView(s.buffer,s.byteOffset,s.length)}peak(){return this.view.getUint8(this.x)}skip(s){this.x+=s}buf(s){const r=this.x+s,i=this.uint8.subarray(this.x,r);return this.x=r,i}u8(){return this.uint8[this.x++]}i8(){return this.view.getInt8(this.x++)}u16(){let s=this.x;const r=(this.uint8[s++]<<8)+this.uint8[s++];return this.x=s,r}i16(){const s=this.view.getInt16(this.x);return this.x+=2,s}u32(){const s=this.view.getUint32(this.x);return this.x+=4,s}i32(){const s=this.view.getInt32(this.x);return this.x+=4,s}u64(){const s=this.view.getBigUint64(this.x);return this.x+=8,s}i64(){const s=this.view.getBigInt64(this.x);return this.x+=8,s}f32(){const s=this.x;return this.x+=4,this.view.getFloat32(s)}f64(){const s=this.x;return this.x+=8,this.view.getFloat64(s)}utf8(s){const r=this.x;return this.x+=s,(0,o.decodeUtf8)(this.uint8,r,s)}ascii(s){const r=this.uint8;let i="";const n=this.x+s;for(let c=this.x;c<n;c++)i+=String.fromCharCode(r[c]);return this.x=n,i}};return xt.Reader=t,xt}var ps;function _n(){if(ps)return wt;ps=1,Object.defineProperty(wt,"__esModule",{value:!0}),wt.CrdtReader=void 0;const o=Or();let t=class extends o.Reader{id(){const s=this.u8();return s<=127?[s>>>4,s&15]:(this.x--,[this.b1vu56()[1],this.vu57()])}idSkip(){this.u8()<=127||(this.x--,this.b1vu56(),this.vu57Skip())}vu57(){const s=this.u8();if(s<=127)return s;const r=this.u8();if(r<=127)return r<<7|s&127;const i=this.u8();if(i<=127)return i<<14|(r&127)<<7|s&127;const n=this.u8();if(n<=127)return n<<21|(i&127)<<14|(r&127)<<7|s&127;const c=this.u8();if(c<=127)return c*268435456+((n&127)<<21|(i&127)<<14|(r&127)<<7|s&127);const a=this.u8();if(a<=127)return a*34359738368+((c&127)*268435456+((n&127)<<21|(i&127)<<14|(r&127)<<7|s&127));const h=this.u8();return h<=127?h*4398046511104+((a&127)*34359738368+((c&127)*268435456+((n&127)<<21|(i&127)<<14|(r&127)<<7|s&127))):this.u8()*562949953421312+((h&127)*4398046511104+((a&127)*34359738368+((c&127)*268435456+((n&127)<<21|(i&127)<<14|(r&127)<<7|s&127))))}vu57Skip(){this.u8()<=127||this.u8()<=127||this.u8()<=127||this.u8()<=127||this.u8()<=127||this.u8()<=127||this.u8()<=127||this.x++}b1vu56(){const s=this.u8(),r=s&128?1:0,i=127&s;if(i<=63)return[r,i];const n=this.u8();if(n<=127)return[r,n<<6|i&63];const c=this.u8();if(c<=127)return[r,c<<13|(n&127)<<6|i&63];const a=this.u8();if(a<=127)return[r,a<<20|(c&127)<<13|(n&127)<<6|i&63];const h=this.u8();if(h<=127)return[r,h*134217728+((a&127)<<20|(c&127)<<13|(n&127)<<6|i&63)];const d=this.u8();if(d<=127)return[r,d*17179869184+((h&127)*134217728+((a&127)<<20|(c&127)<<13|(n&127)<<6|i&63))];const u=this.u8();if(u<=127)return[r,u*2199023255552+((d&127)*17179869184+((h&127)*134217728+((a&127)<<20|(c&127)<<13|(n&127)<<6|i&63)))];const f=this.u8();return[r,f*281474976710656+((u&127)*2199023255552+((d&127)*17179869184+((h&127)*134217728+((a&127)<<20|(c&127)<<13|(n&127)<<6|i&63))))]}};return wt.CrdtReader=t,wt}var gt={},vt={},bs;function On(){return bs||(bs=1,Object.defineProperty(vt,"__esModule",{value:!0}),vt.isUint8Array=void 0,vt.isUint8Array=typeof Buffer=="function"?o=>o instanceof Uint8Array||Buffer.isBuffer(o):o=>o instanceof Uint8Array),vt}var mt={},ws;function Sn(){if(ws)return mt;ws=1,Object.defineProperty(mt,"__esModule",{value:!0}),mt.ORIGIN=void 0;const o=Z();return mt.ORIGIN=(0,o.ts)(0,0),mt}var q={},xs;function Sr(){if(xs)return q;xs=1,Object.defineProperty(q,"__esModule",{value:!0}),q.vec=q.VectorDelayedValue=void 0;class o{constructor(s){this.slots=s}}q.VectorDelayedValue=o;const t=(...e)=>new o(e);return q.vec=t,q}var J={},ys;function jr(){if(ys)return J;ys=1,Object.defineProperty(J,"__esModule",{value:!0}),J.konst=J.Konst=void 0;let o=class{constructor(s){this.val=s}};J.Konst=o;const t=e=>new o(e);return J.konst=t,J}var H={},gs;function Ce(){if(gs)return H;gs=1,Object.defineProperty(H,"__esModule",{value:!0}),H.delayed=H.NodeBuilder=void 0;class o{constructor(s){this.build=s}}H.NodeBuilder=o;const t=e=>new o(e);return H.delayed=t,H}var vs;function Cr(){if(vs)return gt;vs=1,Object.defineProperty(gt,"__esModule",{value:!0}),gt.PatchBuilder=void 0;const o=te(),t=Z(),e=On(),s=$r(),r=Sn(),i=Sr(),n=jr(),c=Ce(),a=d=>{switch(typeof d){case"number":case"boolean":return!0;default:return d===null}};let h=class{constructor(u){this.clock=u,this.patch=new s.Patch}nextTime(){return this.patch.nextTime()||this.clock.time}flush(){const u=this.patch;return this.patch=new s.Patch,u}obj(){this.pad();const u=this.clock.tick(1);return this.patch.ops.push(new o.NewObjOp(u)),u}arr(){this.pad();const u=this.clock.tick(1);return this.patch.ops.push(new o.NewArrOp(u)),u}vec(){this.pad();const u=this.clock.tick(1);return this.patch.ops.push(new o.NewVecOp(u)),u}str(){this.pad();const u=this.clock.tick(1);return this.patch.ops.push(new o.NewStrOp(u)),u}bin(){this.pad();const u=this.clock.tick(1);return this.patch.ops.push(new o.NewBinOp(u)),u}const(u){this.pad();const f=this.clock.tick(1);return this.patch.ops.push(new o.NewConOp(f,u)),f}val(){this.pad();const u=this.clock.tick(1);return this.patch.ops.push(new o.NewValOp(u)),u}root(u){this.pad();const f=this.clock.tick(1);return this.patch.ops.push(new o.InsValOp(f,r.ORIGIN,u)),f}insObj(u,f){if(this.pad(),!f.length)throw new Error("EMPTY_TUPLES");const p=this.clock.tick(1),x=new o.InsObjOp(p,u,f),b=x.span();return b>1&&this.clock.tick(b-1),this.patch.ops.push(x),p}insVec(u,f){if(this.pad(),!f.length)throw new Error("EMPTY_TUPLES");const p=this.clock.tick(1),x=new o.InsVecOp(p,u,f),b=x.span();return b>1&&this.clock.tick(b-1),this.patch.ops.push(x),p}setVal(u,f){this.pad();const p=this.clock.tick(1),x=new o.InsValOp(p,u,f);return this.patch.ops.push(x),p}insStr(u,f,p){if(this.pad(),!p.length)throw new Error("EMPTY_STRING");const x=this.clock.tick(1),b=new o.InsStrOp(x,u,f,p),w=b.span();return w>1&&this.clock.tick(w-1),this.patch.ops.push(b),x}insBin(u,f,p){if(this.pad(),!p.length)throw new Error("EMPTY_BINARY");const x=this.clock.tick(1),b=new o.InsBinOp(x,u,f,p),w=b.span();return w>1&&this.clock.tick(w-1),this.patch.ops.push(b),x}insArr(u,f,p){this.pad();const x=this.clock.tick(1),b=new o.InsArrOp(x,u,f,p),w=b.span();return w>1&&this.clock.tick(w-1),this.patch.ops.push(b),x}del(u,f){this.pad();const p=this.clock.tick(1);return this.patch.ops.push(new o.DelOp(p,u,f)),p}nop(u){this.pad();const f=this.clock.tick(u);return this.patch.ops.push(new o.NopOp(f,u)),f}jsonObj(u){const f=this.obj(),p=Object.keys(u);if(p.length){const x=[];for(const b of p){const w=u[b],y=w instanceof t.Timestamp?w:a(w)?this.const(w):this.json(w);x.push([b,y])}this.insObj(f,x)}return f}jsonArr(u){const f=this.arr();if(u.length){const p=[];for(const x of u)p.push(this.json(x));this.insArr(f,f,p)}return f}jsonStr(u){const f=this.str();return u&&this.insStr(f,f,u),f}jsonBin(u){const f=this.bin();return u.length&&this.insBin(f,f,u),f}jsonVal(u){const f=this.val(),p=this.const(u);return this.setVal(f,p),f}jsonVec(u){const f=this.vec(),p=u.length;if(p){const x=[];for(let b=0;b<p;b++)x.push([b,this.constOrJson(u[b])]);this.insVec(f,x)}return f}json(u){if(u instanceof t.Timestamp)return u;if(u===void 0)return this.const(u);if(u instanceof Array)return this.jsonArr(u);if((0,e.isUint8Array)(u))return this.jsonBin(u);if(u instanceof i.VectorDelayedValue)return this.jsonVec(u.slots);if(u instanceof n.Konst)return this.const(u.val);if(u instanceof c.NodeBuilder)return u.build(this);switch(typeof u){case"object":return u===null?this.jsonVal(u):this.jsonObj(u);case"string":return this.jsonStr(u);case"number":case"boolean":return this.jsonVal(u)}throw new Error("INVALID_JSON")}constOrJson(u){return u instanceof t.Timestamp?u:a(u)?this.const(u):this.json(u)}maybeConst(u){return u instanceof t.Timestamp?u:this.const(u)}pad(){const u=this.patch.nextTime();if(!u)return;const f=this.clock.time-u;if(f>0){const p=(0,t.ts)(this.clock.sid,u),x=new o.NopOp(p,f);this.patch.ops.push(x)}}};return gt.PatchBuilder=h,gt}var kt={},_t={},Ot={},ms;function jn(){if(ms)return Ot;ms=1,Object.defineProperty(Ot,"__esModule",{value:!0}),Ot.decodeF16=void 0;const o=Math.pow,t=e=>{const s=(e&31744)>>10,r=e&1023;return(e>>15?-1:1)*(s?s===31?r?NaN:1/0:o(2,s-15)*(1+r/1024):6103515625e-14*(r/1024))};return Ot.decodeF16=t,Ot}var St={},ks;function Ir(){if(ks)return St;ks=1,Object.defineProperty(St,"__esModule",{value:!0}),St.JsonPackValue=void 0;let o=class{constructor(e){this.val=e}};return St.JsonPackValue=o,St}var Jt={},jt={},Ht={},_s;function Cn(){if(_s)return Ht;_s=1,Object.defineProperty(Ht,"__esModule",{value:!0});const o=String.fromCharCode;return Ht.default=(t,e,s)=>{let r=e;const i=r+s;let n="";for(;r<i;){const c=t[r++];if(!(c&128)){n+=o(c);continue}const a=t[r++]&63;if((c&224)===192){n+=o((c&31)<<6|a);continue}const h=t[r++]&63;if((c&240)===224){n+=o((c&31)<<12|a<<6|h);continue}if((c&248)===240){const d=t[r++]&63;let u=(c&7)<<18|a<<12|h<<6|d;if(u>65535){u-=65536;const f=u>>>10&1023|55296;u=56320|u&1023,n+=o(f,u)}else n+=o(u)}else n+=o(c)}return n},Ht}var Os;function In(){if(Os)return jt;Os=1,Object.defineProperty(jt,"__esModule",{value:!0}),jt.CachedUtf8Decoder=void 0;const t=T.__importDefault(Cn()),e=Ms();class s{constructor(n,c){this.bytes=n,this.value=c}}let r=class{constructor(){this.caches=[];for(let n=0;n<31;n++)this.caches.push([])}get(n,c,a){const h=this.caches[a-1],d=h.length;t:for(let u=0;u<d;u++){const f=h[u],p=f.bytes;for(let x=0;x<a;x++)if(p[x]!==n[c+x])continue t;return f.value}return null}store(n,c){const a=this.caches[n.length-1],h=new s(n,c);a.length>=16?a[(0,e.randomU32)(0,15)]=h:a.push(h)}decode(n,c,a){if(!a)return"";const h=this.get(n,c,a);if(h!==null)return h;const d=(0,t.default)(n,c,a),u=Uint8Array.prototype.slice.call(n,c,c+a);return this.store(u,d),d}};return jt.CachedUtf8Decoder=r,jt}var Ss;function Nn(){if(Ss)return Jt;Ss=1,Object.defineProperty(Jt,"__esModule",{value:!0});const o=In();return Jt.default=new o.CachedUtf8Decoder,Jt}var js;function An(){if(js)return _t;js=1,Object.defineProperty(_t,"__esModule",{value:!0}),_t.CborDecoderBase=void 0;const o=T,t=jn(),e=kr(),s=Ir(),r=Or(),i=o.__importDefault(Nn());let n=class{constructor(a=new r.Reader,h=i.default){this.reader=a,this.keyDecoder=h}read(a){return this.reader.reset(a),this.val()}decode(a){return this.reader.reset(a),this.val()}val(){const h=this.reader.u8(),d=h>>5,u=h&31;return d<4?d<2?d===0?this.readUint(u):this.readNint(u):d===2?this.readBin(u):this.readStr(u):d<6?d===4?this.readArr(u):this.readObj(u):d===6?this.readTag(u):this.readTkn(u)}readAnyRaw(a){const h=a>>5,d=a&31;return h<4?h<2?h===0?this.readUint(d):this.readNint(d):h===2?this.readBin(d):this.readStr(d):h<6?h===4?this.readArr(d):this.readObj(d):h===6?this.readTag(d):this.readTkn(d)}readMinorLen(a){if(a<24)return a;switch(a){case 24:return this.reader.u8();case 25:return this.reader.u16();case 26:return this.reader.u32();case 27:return Number(this.reader.u64());case 31:return-1;default:throw 1}}readUint(a){if(a<25)return a===24?this.reader.u8():a;if(a<27)return a===25?this.reader.u16():this.reader.u32();{const h=this.reader.u64();return h>9007199254740991?h:Number(h)}}readNint(a){if(a<25)return a===24?-this.reader.u8()-1:-a-1;if(a<27)return a===25?-this.reader.u16()-1:-this.reader.u32()-1;{const h=this.reader.u64();return h>9007199254740991-1?-h-BigInt(1):-Number(h)-1}}readBin(a){const h=this.reader;if(a<=23)return h.buf(a);switch(a){case 24:return h.buf(h.u8());case 25:return h.buf(h.u16());case 26:return h.buf(h.u32());case 27:return h.buf(Number(h.u64()));case 31:{let d=0;const u=[];for(;this.reader.peak()!==255;){const b=this.readBinChunk();d+=b.length,u.push(b)}this.reader.x++;const f=new Uint8Array(d);let p=0;const x=u.length;for(let b=0;b<x;b++){const w=u[b];f.set(w,p),p+=w.length}return f}default:throw 1}}readBinChunk(){const a=this.reader.u8(),h=a>>5,d=a&31;if(h!==2)throw 2;if(d>27)throw 3;return this.readBin(d)}readAsStr(){const h=this.reader.u8(),d=h>>5,u=h&31;if(d!==3)throw 11;return this.readStr(u)}readStr(a){const h=this.reader;if(a<=23)return h.utf8(a);switch(a){case 24:return h.utf8(h.u8());case 25:return h.utf8(h.u16());case 26:return h.utf8(h.u32());case 27:return h.utf8(Number(h.u64()));case 31:{let d="";for(;h.peak()!==255;)d+=this.readStrChunk();return this.reader.x++,d}default:throw 1}}readStrLen(a){if(a<=23)return a;switch(a){case 24:return this.reader.u8();case 25:return this.reader.u16();case 26:return this.reader.u32();case 27:return Number(this.reader.u64());default:throw 1}}readStrChunk(){const a=this.reader.u8(),h=a>>5,d=a&31;if(h!==3)throw 4;if(d>27)throw 5;return this.readStr(d)}readArr(a){const h=this.readMinorLen(a);return h>=0?this.readArrRaw(h):this.readArrIndef()}readArrRaw(a){const h=[];for(let d=0;d<a;d++)h.push(this.val());return h}readArrIndef(){const a=[];for(;this.reader.peak()!==255;)a.push(this.val());return this.reader.x++,a}readObj(a){if(a<28){let h=a;switch(a){case 24:h=this.reader.u8();break;case 25:h=this.reader.u16();break;case 26:h=this.reader.u32();break;case 27:h=Number(this.reader.u64());break}const d={};for(let u=0;u<h;u++){const f=this.key();if(f==="__proto__")throw 6;const p=this.val();d[f]=p}return d}else{if(a===31)return this.readObjIndef();throw 1}}readObjRaw(a){const h={};for(let d=0;d<a;d++){const u=this.key(),f=this.val();h[u]=f}return h}readObjIndef(){const a={};for(;this.reader.peak()!==255;){const h=this.key();if(this.reader.peak()===255)throw 7;const d=this.val();a[h]=d}return this.reader.x++,a}key(){const a=this.reader.u8(),h=a>>5,d=a&31;if(h!==3)return String(this.readAnyRaw(a));const u=this.readStrLen(d);if(u>31)return this.reader.utf8(u);const f=this.keyDecoder.decode(this.reader.uint8,this.reader.x,u);return this.reader.skip(u),f}readTag(a){if(a<=23)return this.readTagRaw(a);switch(a){case 24:return this.readTagRaw(this.reader.u8());case 25:return this.readTagRaw(this.reader.u16());case 26:return this.readTagRaw(this.reader.u32());case 27:return this.readTagRaw(Number(this.reader.u64()));default:throw 1}}readTagRaw(a){return new e.JsonPackExtension(a,this.val())}readTkn(a){switch(a){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;case 24:return new s.JsonPackValue(this.reader.u8());case 25:return this.f16();case 26:return this.reader.f32();case 27:return this.reader.f64()}if(a<=23)return new s.JsonPackValue(a);throw 1}f16(){return(0,t.decodeF16)(this.reader.u16())}};return _t.CborDecoderBase=n,_t}var Cs;function $n(){if(Cs)return kt;Cs=1,Object.defineProperty(kt,"__esModule",{value:!0}),kt.CborDecoder=void 0;const o=An(),t=Ir();let e=class extends o.CborDecoderBase{readAsMap(){const r=this.reader.u8(),i=r>>5,n=r&31;switch(i){case 5:return this.readMap(n);default:throw 0}}readMap(r){const i=this.readMinorLen(r);return i>=0?this.readMapRaw(i):this.readMapIndef()}readMapRaw(r){const i=new Map;for(let n=0;n<r;n++){const c=this.val(),a=this.val();i.set(c,a)}return i}readMapIndef(){const r=new Map;for(;this.reader.peak()!==255;){const i=this.val();if(this.reader.peak()===255)throw 7;const n=this.val();r.set(i,n)}return this.reader.x++,r}skipN(r){for(let i=0;i<r;i++)this.skipAny()}skipAny(){this.skipAnyRaw(this.reader.u8())}skipAnyRaw(r){const i=r>>5,n=r&31;switch(i){case 0:case 1:this.skipUNint(n);break;case 2:this.skipBin(n);break;case 3:this.skipStr(n);break;case 4:this.skipArr(n);break;case 5:this.skipObj(n);break;case 7:this.skipTkn(n);break;case 6:this.skipTag(n);break}}skipMinorLen(r){if(r<=23)return r;switch(r){case 24:return this.reader.u8();case 25:return this.reader.u16();case 26:return this.reader.u32();case 27:return Number(this.reader.u64());case 31:return-1;default:throw 1}}skipUNint(r){if(!(r<=23))switch(r){case 24:return this.reader.skip(1);case 25:return this.reader.skip(2);case 26:return this.reader.skip(4);case 27:return this.reader.skip(8);default:throw 1}}skipBin(r){const i=this.skipMinorLen(r);if(i>=0)this.reader.skip(i);else{for(;this.reader.peak()!==255;)this.skipBinChunk();this.reader.x++}}skipBinChunk(){const r=this.reader.u8(),i=r>>5,n=r&31;if(i!==2)throw 2;if(n>27)throw 3;this.skipBin(n)}skipStr(r){const i=this.skipMinorLen(r);if(i>=0)this.reader.skip(i);else{for(;this.reader.peak()!==255;)this.skipStrChunk();this.reader.x++}}skipStrChunk(){const r=this.reader.u8(),i=r>>5,n=r&31;if(i!==3)throw 4;if(n>27)throw 5;this.skipStr(n)}skipArr(r){const i=this.skipMinorLen(r);if(i>=0)this.skipN(i);else{for(;this.reader.peak()!==255;)this.skipAny();this.reader.x++}}skipObj(r){const i=this.readMinorLen(r);if(i>=0)return this.skipN(i*2);for(;this.reader.peak()!==255;){if(this.skipAny(),this.reader.peak()===255)throw 7;this.skipAny()}this.reader.x++}skipTag(r){if(this.skipMinorLen(r)<0)throw 1;this.skipAny()}skipTkn(r){switch(r){case 24:this.reader.skip(1);return;case 25:this.reader.skip(2);return;case 26:this.reader.skip(4);return;case 27:this.reader.skip(8);return}if(!(r<=23))throw 1}validate(r,i=0,n=r.length){this.reader.reset(r),this.reader.x=i;const c=i;if(this.skipAny(),this.reader.x-c!==n)throw 8}decodeLevel(r){return this.reader.reset(r),this.readLevel()}readLevel(){const r=this.reader.u8(),i=r>>5,n=r&31;switch(i){case 4:return this.readArrLevel(n);case 5:return this.readObjLevel(n);default:return super.readAnyRaw(r)}}readPrimitiveOrVal(){switch(this.reader.peak()>>5){case 4:case 5:return this.readAsValue();default:return this.val()}}readAsValue(){const r=this.reader,i=r.x;this.skipAny();const n=r.x;return new t.JsonPackValue(r.uint8.subarray(i,n))}readObjLevel(r){const i=this.readMinorLen(r);return i>=0?this.readObjRawLevel(i):this.readObjIndefLevel()}readObjRawLevel(r){const i={};for(let n=0;n<r;n++){const c=this.key(),a=this.readPrimitiveOrVal();i[c]=a}return i}readObjIndefLevel(){const r={};for(;this.reader.peak()!==255;){const i=this.key();if(this.reader.peak()===255)throw 7;const n=this.readPrimitiveOrVal();r[i]=n}return this.reader.x++,r}readArrLevel(r){const i=this.readMinorLen(r);return i>=0?this.readArrRawLevel(i):this.readArrIndefLevel()}readArrRawLevel(r){const i=[];for(let n=0;n<r;n++)i.push(this.readPrimitiveOrVal());return i}readArrIndefLevel(){const r=[];for(;this.reader.peak()!==255;)r.push(this.readPrimitiveOrVal());return this.reader.x++,r}readHdr(r){const i=this.reader.u8();if(i>>5!==r)throw 0;const c=i&31;if(c<24)return c;switch(c){case 24:return this.reader.u8();case 25:return this.reader.u16();case 26:return this.reader.u32();case 27:return Number(this.reader.u64());case 31:return-1}throw 1}readStrHdr(){return this.readHdr(3)}readObjHdr(){return this.readHdr(5)}readArrHdr(){return this.readHdr(4)}findKey(r){const i=this.readObjHdr();for(let n=0;n<i;n++){if(this.key()===r)return this;this.skipAny()}throw 9}findIndex(r){const i=this.readArrHdr();if(r>=i)throw 10;for(let n=0;n<r;n++)this.skipAny();return this}find(r){for(let i=0;i<r.length;i++){const n=r[i];typeof n=="string"?this.findKey(n):this.findIndex(n)}return this}};return kt.CborDecoder=e,kt}var Is;function Nr(){if(Is)return bt;Is=1,Object.defineProperty(bt,"__esModule",{value:!0}),bt.Decoder=void 0;const o=_n(),t=Z(),e=Cr(),s=$n();let r=class extends s.CborDecoder{constructor(n=new o.CrdtReader){super(n)}decode(n){const c=this.reader;c.reset(n);const a=c.vu57(),h=c.vu57(),u=a===1?new t.ServerClockVector(1,h):new t.ClockVector(a,h);this.patchSid=u.sid;const f=this.builder=new e.PatchBuilder(u),p=this.val();return p instanceof Array&&(f.patch.meta=p[0]),this.decodeOperations(),f.patch}decodeId(){const n=this.reader,[c,a]=n.b1vu56();return c?new t.Timestamp(n.vu57(),a):new t.Timestamp(this.patchSid,a)}decodeTss(){const n=this.decodeId(),c=this.reader.vu57();return(0,t.interval)(n,0,c)}decodeOperations(){const c=this.reader.vu57();for(let a=0;a<c;a++)this.decodeOperation()}decodeOperation(){const n=this.builder,c=this.reader,a=c.u8();switch(a>>3){case 0:{const d=a&7;n.const(d?this.decodeId():this.val());break}case 1:{n.val();break}case 2:{n.obj();break}case 3:{n.vec();break}case 4:{n.str();break}case 5:{n.bin();break}case 6:{n.arr();break}case 9:{const d=this.decodeId(),u=this.decodeId();n.setVal(d,u);break}case 10:{const d=a&7||c.vu57(),u=this.decodeId(),f=[];for(let p=0;p<d;p++){const x=this.val();if(typeof x!="string")continue;const b=this.decodeId();f.push([x,b])}n.insObj(u,f);break}case 11:{const d=a&7||c.vu57(),u=this.decodeId(),f=[];for(let p=0;p<d;p++){const x=this.val();if(typeof x!="number")continue;const b=this.decodeId();f.push([x,b])}n.insVec(u,f);break}case 12:{const d=a&7||c.vu57(),u=this.decodeId(),f=this.decodeId(),p=c.utf8(d);n.insStr(u,f,p);break}case 13:{const d=a&7||c.vu57(),u=this.decodeId(),f=this.decodeId(),p=c.buf(d);if(!(p instanceof Uint8Array))return;n.insBin(u,f,p);break}case 14:{const d=a&7||c.vu57(),u=this.decodeId(),f=this.decodeId(),p=[];for(let x=0;x<d;x++)p.push(this.decodeId());n.insArr(u,f,p);break}case 16:{const d=a&7||c.vu57(),u=this.decodeId(),f=[];for(let p=0;p<d;p++)f.push(this.decodeTss());n.del(u,f);break}case 17:{const d=a&7||c.vu57();n.nop(d);break}default:throw new Error("UNKNOWN_OP")}}};return bt.Decoder=r,bt}var ae={},Ns;function En(){return Ns||(Ns=1,function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.decode=o.decoder=o.encode=o.encoder=void 0;const t=_r(),e=Nr(),s=mr(),r=new s.CrdtWriter(1024*4);o.encoder=new t.Encoder(r);const i=c=>o.encoder.encode(c);o.encode=i,o.decoder=new e.Decoder;const n=c=>o.decoder.decode(c);o.decode=n}(ae)),ae}var As;function Tn(){return As||(As=1,function(o){Object.defineProperty(o,"__esModule",{value:!0});const t=T;t.__exportStar(_r(),o),t.__exportStar(Nr(),o),t.__exportStar(En(),o)}(ce)),ce}var $s;function $r(){if($s)return ot;$s=1,Object.defineProperty(ot,"__esModule",{value:!0}),ot.Patch=void 0;const t=T.__importStar(te()),e=Z(),s=Tn();let r=class Ar{constructor(){this.ops=[],this.meta=void 0}static fromBinary(n){return(0,s.decode)(n)}getId(){const n=this.ops[0];if(n)return n.id}span(){let n=0;for(const c of this.ops)n+=c.span();return n}nextTime(){const n=this.ops,c=n.length;if(!c)return 0;const a=n[c-1];return a.id.time+a.span()}rewriteTime(n){const c=new Ar,a=this.ops,h=a.length,d=c.ops;for(let u=0;u<h;u++){const f=a[u];f instanceof t.DelOp?d.push(new t.DelOp(n(f.id),n(f.obj),f.what)):f instanceof t.NewConOp?d.push(new t.NewConOp(n(f.id),f.val)):f instanceof t.NewVecOp?d.push(new t.NewVecOp(n(f.id))):f instanceof t.NewValOp?d.push(new t.NewValOp(n(f.id))):f instanceof t.NewObjOp?d.push(new t.NewObjOp(n(f.id))):f instanceof t.NewStrOp?d.push(new t.NewStrOp(n(f.id))):f instanceof t.NewBinOp?d.push(new t.NewBinOp(n(f.id))):f instanceof t.NewArrOp?d.push(new t.NewArrOp(n(f.id))):f instanceof t.InsArrOp?d.push(new t.InsArrOp(n(f.id),n(f.obj),n(f.ref),f.data.map(n))):f instanceof t.InsStrOp?d.push(new t.InsStrOp(n(f.id),n(f.obj),n(f.ref),f.data)):f instanceof t.InsBinOp?d.push(new t.InsBinOp(n(f.id),n(f.obj),n(f.ref),f.data)):f instanceof t.InsValOp?d.push(new t.InsValOp(n(f.id),n(f.obj),n(f.val))):f instanceof t.InsObjOp?d.push(new t.InsObjOp(n(f.id),n(f.obj),f.data.map(([p,x])=>[p,n(x)]))):f instanceof t.NopOp&&d.push(new t.NopOp(n(f.id),f.len))}return c}rebase(n,c){const a=this.getId();if(!a)throw new Error("EMPTY_PATCH");const h=a.time;if(h===n)return this;const d=n-h;return this.rewriteTime(u=>{if(!(u.sid===1))return u;const x=u.time;return x<c?u:(0,e.ts)(1,x+d)})}clone(){return this.rewriteTime(n=>n)}toBinary(){return(0,s.encode)(this)}toString(n=""){const c=this.getId();let a=`${this.constructor.name} ${c?(0,e.toDisplayString)(c):"(nil)"}!${this.span()}`;for(let h=0;h<this.ops.length;h++){const d=h===this.ops.length-1;a+=`
${n}${d?"└─":"├─"} ${this.ops[h].toString(n+(d?"  ":"│ "))}`}return a}};return ot.Patch=r,ot}var he={},Es;function Bn(){return Es||(Es=1,function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.s=o.schema=o.nodes=void 0;const t=Ce();var e;(function(s){class r extends t.NodeBuilder{constructor(f){super(p=>p.const(f)),this.raw=f,this.type="con"}}s.con=r;class i extends t.NodeBuilder{constructor(f){super(p=>p.json(f)),this.raw=f,this.type="str"}}s.str=i;class n extends t.NodeBuilder{constructor(f){super(p=>p.json(f)),this.raw=f,this.type="bin"}}s.bin=n;class c extends t.NodeBuilder{constructor(f){super(p=>{const x=p.val(),b=f.build(p);return p.setVal(x,b),x}),this.value=f,this.type="val"}}s.val=c;class a extends t.NodeBuilder{constructor(f){super(p=>{const x=p.vec(),b=f.length;if(b){const w=[];for(let y=0;y<b;y++){const v=f[y].build(p);w.push([y,v])}p.insVec(x,w)}return x}),this.value=f,this.type="vec"}}s.vec=a;class h extends t.NodeBuilder{constructor(f,p){super(x=>{const b=x.obj(),w=[],y={...f,...p},g=Object.keys(y),v=g.length;if(v){for(let _=0;_<v;_++){const ee=g[_],Er=y[ee].build(x);w.push([ee,Er])}x.insObj(b,w)}return b}),this.obj=f,this.opt=p,this.type="obj"}optional(){return this}}s.obj=h;class d extends t.NodeBuilder{constructor(f){super(p=>{const x=p.arr(),b=f.length;if(b){const w=[];for(let y=0;y<b;y++)w.push(f[y].build(p));p.insArr(x,x,w)}return x}),this.arr=f,this.type="arr"}}s.arr=d})(e||(o.nodes=e={})),o.schema={con:s=>new e.con(s),str:s=>new e.str(s||""),bin:s=>new e.bin(s),val:s=>new e.val(s),vec:(...s)=>new e.vec(s),obj:(s,r)=>new e.obj(s,r),map:s=>o.schema.obj(s),arr:s=>new e.arr(s)},o.s=o.schema}(he)),he}(function(o){Object.defineProperty(o,"__esModule",{value:!0});const t=T;t.__exportStar(fn(),o),t.__exportStar(Z(),o),t.__exportStar(te(),o),t.__exportStar($r(),o),t.__exportStar(Cr(),o),t.__exportStar(Bn(),o),t.__exportStar(jr(),o),t.__exportStar(Sr(),o),t.__exportStar(Ce(),o)})(Wt);window.JSONJoy={Model:K,Timespan:be,Timestamp:O,ArrNode:$,BinNode:D,ConNode:L,ObjNode:V,StrNode:U,ValNode:P,VecNode:R,Patch:Wt.Patch,Schema:Wt.s,konst:Wt.konst};
//# sourceMappingURL=json-joy-bundle.js.map
